<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Bloom & Drizzle ğŸŒ¸</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--ui:#fff8f0ee;--g:#fff8f0dd;--gb:rgba(255,255,255,.35);--t:#4a3728;--tl:#8a7a68;--ac:#e8a87c;--ac2:#85c88a;--ac3:#c490d1;--dn:#e07070;--sh:0 4px 14px rgba(60,40,20,.15);--st:env(safe-area-inset-top,0px);--sb:env(safe-area-inset-bottom,0px)}
html,body{font-family:'Fredoka',sans-serif;background:#2a2035;color:var(--t);overflow:hidden;width:100%;height:100%;position:fixed;touch-action:none;-webkit-tap-highlight-color:transparent;user-select:none}
canvas{position:fixed;top:0;left:0;width:100%;height:100%}
#rc{z-index:1;pointer-events:none}#gc{z-index:0}
.ui{position:fixed;top:0;left:0;width:100%;height:100%;z-index:10;pointer-events:none}.ui>*{pointer-events:auto}
.top{position:absolute;top:calc(8px + var(--st));left:8px;right:8px;display:flex;justify-content:center;gap:4px;flex-wrap:wrap;z-index:20}
.tp{background:var(--g);backdrop-filter:blur(12px);border:1px solid var(--gb);border-radius:18px;padding:4px 10px;font-weight:600;font-size:12px;display:flex;align-items:center;gap:4px;box-shadow:var(--sh);white-space:nowrap}
.xb{width:40px;height:6px;background:rgba(0,0,0,.1);border-radius:3px;overflow:hidden}.xf{height:100%;background:linear-gradient(90deg,var(--ac3),#e080d0);border-radius:3px;transition:width .4s}
.dock{position:absolute;bottom:calc(8px + var(--sb));left:50%;transform:translateX(-50%);display:flex;gap:3px;z-index:20;flex-wrap:wrap;justify-content:center;max-width:calc(100% - 16px)}
.db{background:var(--g);backdrop-filter:blur(12px);border:1.5px solid var(--gb);border-radius:14px;padding:8px 10px;font-weight:500;font-size:11px;cursor:pointer;display:flex;align-items:center;gap:4px;box-shadow:var(--sh);transition:all .12s;color:var(--t);min-width:42px;min-height:42px;justify-content:center}
.db:active{transform:scale(.93)}.em{font-size:16px;font-style:normal}
.po{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(40,30,50,.5);backdrop-filter:blur(3px);z-index:50;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}.po.on{opacity:1;pointer-events:auto}
.pn{background:var(--ui);border:1.5px solid var(--gb);border-radius:22px 22px 0 0;padding:20px 16px calc(20px + var(--sb));max-width:540px;width:100%;max-height:85vh;overflow-y:auto;-webkit-overflow-scrolling:touch;box-shadow:0 -8px 30px rgba(40,20,10,.2);transform:translateY(100%);transition:transform .25s}.po.on .pn{transform:translateY(0)}
.pn::-webkit-scrollbar{width:4px}.pn::-webkit-scrollbar-thumb{background:rgba(180,160,140,.3);border-radius:2px}
.ph{width:34px;height:4px;background:rgba(180,160,140,.3);border-radius:2px;margin:0 auto 12px}
.pn h2{font-weight:700;font-size:18px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.pc{position:absolute;top:12px;right:14px;background:rgba(180,160,140,.2);border:none;border-radius:50%;width:32px;height:32px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--tl)}.pc:active{background:rgba(180,160,140,.4)}
.sg{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:6px}
.si{background:rgba(255,255,255,.6);border:1.5px solid rgba(200,180,160,.3);border-radius:12px;padding:9px 6px;text-align:center;cursor:pointer;transition:all .12s;min-height:42px}
.si:active{transform:scale(.96);border-color:var(--ac)}.si .fi{font-size:24px;display:block;margin-bottom:2px}.si .fn{font-weight:600;font-size:11px}.si .fc{font-size:10px;color:#b8860b;margin-top:1px}.si .ft{font-size:9px;color:var(--tl)}
.rt{font-size:8px;padding:1px 5px;border-radius:7px;display:inline-block;margin-top:1px}
.rt.common{background:#e8f0e0;color:#5a7a40}.rt.uncommon{background:#e0e8f0;color:#4060a0}.rt.rare{background:#f0e0f0;color:#8040a0}.rt.epic{background:#f0e0e8;color:#a04080}.rt.legendary{background:#f8f0d0;color:#a08020}
.si.locked{opacity:.3;pointer-events:none}
.ig{display:flex;flex-wrap:wrap;gap:5px;margin:8px 0}
.ii{background:rgba(255,255,255,.5);border:1.5px solid rgba(200,180,160,.3);border-radius:10px;padding:5px 8px;display:flex;align-items:center;gap:5px;font-size:12px}.ii .ct{font-weight:700;color:var(--ac)}
.oc{background:rgba(255,255,255,.5);border:1.5px solid rgba(200,180,160,.3);border-radius:12px;padding:10px;margin-bottom:6px;position:relative}
.oc .tm{position:absolute;top:8px;right:10px;font-weight:600;font-size:12px}
.fb{background:var(--ac2);color:white;border:none;border-radius:10px;padding:7px 14px;font-weight:600;font-size:11px;cursor:pointer;margin-top:4px;min-height:34px;font-family:'Fredoka'}.fb:active{transform:scale(.96)}.fb:disabled{opacity:.4}
.tc{background:rgba(255,255,255,.5);border:1.5px solid rgba(200,180,160,.3);border-radius:12px;padding:10px;margin-bottom:6px;display:flex;align-items:center;gap:10px}
.tc .ti{font-size:24px}.tc .tinf{flex:1}.tc .tn{font-weight:600;font-size:13px}.tc .td{font-size:10px;color:var(--tl)}.tc .tl{font-size:9px;color:var(--ac3);font-weight:600}
.ub{background:var(--ac);color:white;border:none;border-radius:10px;padding:7px 12px;font-weight:600;font-size:11px;cursor:pointer;min-height:34px;font-family:'Fredoka'}.ub:active{transform:scale(.96)}.ub:disabled{opacity:.4}.ub.mx{background:var(--ac2)}
.bs{display:flex;gap:5px;justify-content:center;margin:10px 0;flex-wrap:wrap}
.bsl{width:48px;height:48px;background:rgba(255,255,255,.4);border:2px dashed rgba(180,160,140,.4);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;min-width:42px;min-height:42px}
.bsl.filled{border-style:solid;border-color:var(--ac2);background:rgba(230,250,230,.5)}
.br{text-align:center;padding:10px;background:rgba(255,255,255,.4);border-radius:12px;margin-top:6px}
.br .price{font-weight:700;font-size:17px;color:#b8860b}
.br .rm{color:var(--ac3);font-weight:700}
.cat-card{background:linear-gradient(135deg,rgba(255,240,220,.8),rgba(255,220,200,.6));border:1.5px solid rgba(240,168,64,.3);border-radius:13px;padding:10px;margin-bottom:8px;display:flex;align-items:center;gap:10px}
.meter{width:100%;height:6px;background:rgba(0,0,0,.1);border-radius:3px;overflow:hidden;margin:2px 0}
.meter-fill{height:100%;border-radius:3px;transition:width .4s}
.mh .meter-fill{background:linear-gradient(90deg,#e07070,#f0a060)}.mp .meter-fill{background:linear-gradient(90deg,#f0c040,#f080a0)}.mt .meter-fill{background:linear-gradient(90deg,#80b0f0,#a080e0)}
.cat-food{display:flex;align-items:center;gap:8px;padding:7px;border-radius:10px;cursor:pointer;background:rgba(255,255,255,.5);margin-bottom:4px}.cat-food:active{background:rgba(255,220,180,.6)}
.cat-acc{display:inline-flex;align-items:center;gap:4px;padding:5px 9px;border-radius:10px;cursor:pointer;background:rgba(255,255,255,.5);margin:2px;font-size:11px;border:1.5px solid transparent}.cat-acc.eq{background:rgba(133,200,138,.3);border-color:var(--ac2)}.cat-acc:active{transform:scale(.95)}
.ach{display:flex;align-items:center;gap:7px;padding:7px;border-radius:11px;margin-bottom:4px}
.ach.done{background:rgba(255,240,200,.5);border:1px solid rgba(240,200,80,.3)}.ach.todo{background:rgba(200,200,200,.1);opacity:.6}
.ss{position:fixed;z-index:55;background:var(--ui);border-radius:20px 20px 0 0;padding:14px;padding-bottom:calc(14px + var(--sb));box-shadow:0 -6px 24px rgba(40,20,10,.2);bottom:0;left:0;right:0;max-height:50vh;overflow-y:auto;transform:translateY(100%);transition:transform .25s}.ss.on{transform:translateY(0)}
.so{display:flex;align-items:center;gap:8px;padding:8px 6px;border-radius:10px;cursor:pointer;min-height:42px}.so:active{background:rgba(232,168,124,.2)}
.fv{position:fixed;top:0;left:0;width:100%;height:100%;z-index:15;pointer-events:none;display:none}.fv>*{pointer-events:auto}
.bbk{position:absolute;top:calc(10px + var(--st));left:10px;background:var(--g);backdrop-filter:blur(12px);border:1.5px solid var(--gb);border-radius:14px;padding:8px 12px;font-weight:600;font-size:12px;cursor:pointer;box-shadow:var(--sh);min-height:42px;display:flex;align-items:center;gap:3px}.bbk:active{transform:scale(.95)}
.fbb{position:absolute;bottom:calc(10px + var(--sb));left:50%;transform:translateX(-50%);display:flex;gap:5px}
.ffb,.hab{backdrop-filter:blur(12px);border-radius:14px;padding:8px 12px;font-weight:600;font-size:12px;cursor:pointer;box-shadow:var(--sh);min-height:42px;font-family:'Fredoka';border:2px solid}
.hab{background:rgba(200,240,200,.9);border-color:var(--ac2);color:#3a7a3a}.ffb{background:rgba(255,240,200,.9);border-color:#f0c040;color:#a08020}.ffb.on{background:#f0c040;color:#fff}
.pov{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(40,30,50,.5);z-index:56;display:none;align-items:center;justify-content:center}.pov.on{display:flex}
.pp{background:var(--ui);border-radius:20px;padding:22px;text-align:center;box-shadow:0 16px 50px rgba(40,20,10,.3);width:85%;max-width:280px}
.pp h3{font-weight:700;font-size:16px;margin-bottom:5px}.pp .pr{font-size:20px;color:#b8860b;font-weight:700}
.pb{display:flex;gap:7px;justify-content:center;margin-top:12px}
.pbtn{border:none;border-radius:12px;padding:9px 18px;font-weight:600;font-size:12px;cursor:pointer;min-height:42px;font-family:'Fredoka'}.pbtn.cf{background:var(--ac2);color:white}.pbtn.cf:disabled{opacity:.5}.pbtn.cn{background:rgba(180,160,140,.2);color:var(--tl)}
.popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);z-index:200;border-radius:20px;padding:22px 28px;text-align:center;transition:transform .35s cubic-bezier(.34,1.56,.64,1);pointer-events:none}
.popup.show{transform:translate(-50%,-50%) scale(1)}
.popup-ach{background:linear-gradient(135deg,#fff8e0,#fff0d0);border:2px solid #f0c040;box-shadow:0 10px 40px rgba(200,160,40,.3)}
.popup-lvl{background:linear-gradient(135deg,#f0e0ff,#e0d0ff);border:2px solid var(--ac3);box-shadow:0 10px 40px rgba(160,80,200,.3)}
.toasts{position:fixed;top:calc(48px + var(--st));left:50%;transform:translateX(-50%);z-index:100;display:flex;flex-direction:column;gap:4px;pointer-events:none;align-items:center;width:90%;max-width:300px}
.toast{background:var(--g);backdrop-filter:blur(12px);border:1.5px solid var(--gb);border-radius:10px;padding:6px 12px;font-weight:500;font-size:11px;box-shadow:var(--sh);animation:ti .25s ease,to .3s ease 2s forwards;text-align:center;width:fit-content;max-width:100%}
@keyframes ti{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
@keyframes to{from{opacity:1}to{opacity:0;transform:translateY(-8px)}}
.guide-btn{position:absolute;top:calc(44px + var(--st));right:8px;background:var(--g);backdrop-filter:blur(12px);border:1.5px solid var(--gb);border-radius:50%;width:34px;height:34px;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:var(--sh);z-index:20;color:var(--ac)}.guide-btn:active{transform:scale(.93)}
.guide-page{padding:10px 0}.guide-page h3{font-size:14px;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.guide-page p{font-size:11px;color:var(--tl);line-height:1.6;margin-bottom:8px}
.guide-nav{display:flex;justify-content:center;gap:8px;margin-top:10px}
.guide-dot{width:8px;height:8px;border-radius:50%;background:rgba(180,160,140,.3);cursor:pointer}.guide-dot.active{background:var(--ac)}
.sl{font-weight:600;font-size:12px;color:var(--tl);margin:8px 0 4px}
.et{color:var(--tl);padding:14px;text-align:center;font-size:12px}
.fog{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1}
.lf{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,240,.3);pointer-events:none;z-index:2;animation:fl .15s ease}
@keyframes fl{0%{opacity:1}100%{opacity:0}}
@media(max-width:380px){.tp{padding:3px 7px;font-size:10px}.db{padding:6px 7px;font-size:9px}.db .lb{display:none}}
@media(min-width:381px) and (max-width:600px){.db .lb{display:none}}
@media(min-width:601px){.pn{border-radius:22px;max-height:80vh;margin-bottom:40px}.po{align-items:center}}
</style></head><body>
<canvas id="gc"></canvas><canvas id="rc"></canvas>
<div class="ui" id="ui">
  <div class="top"><div class="tp" style="color:#b8860b">ğŸª™ <span id="coins">250</span></div>
    <div class="tp" style="color:var(--ac3)">â­ Lv<span id="lvl">1</span> <div class="xb"><div class="xf" id="xpF" style="width:0%"></div></div></div>
    <div class="tp"><span id="wI">ğŸŒ§ï¸</span> <span id="wL">Rain</span></div>
    <div class="tp">â˜€ï¸ <span id="dayN">1</span></div>
    <button class="tp" id="sndB" onclick="toggleSnd()" style="cursor:pointer;border:none">ğŸ”Š</button></div>
  <button class="guide-btn" onclick="op('guide')">â„¹ï¸</button>
  <div class="dock" id="dock">
    <button class="db" onclick="SFX.click();op('shop')"><i class="em">ğŸŒ±</i><span class="lb">Seeds</span></button>
    <button class="db" onclick="SFX.click();op('bouquet')"><i class="em">ğŸ’</i><span class="lb">Bouquet</span></button>
    <button class="db" onclick="SFX.click();op('orders')"><i class="em">ğŸ“‹</i><span class="lb">Orders</span></button>
    <button class="db" onclick="SFX.click();op('tools')"><i class="em">ğŸ”§</i><span class="lb">Tools</span></button>
    <button class="db" onclick="SFX.click();op('cat')"><i class="em">ğŸ±</i><span class="lb">Mochi</span></button>
    <button class="db" onclick="SFX.click();op('achieve')"><i class="em">ğŸ†</i><span class="lb">Goals</span></button>
    <button class="db" onclick="SFX.click();op('inv')"><i class="em">ğŸ’</i><span class="lb">Items</span></button></div>
  <div class="toasts" id="toastC"></div></div>
<div class="po" id="panelO" onclick="if(event.target===this)cp()"><div class="pn" id="panelC" style="position:relative"></div></div>
<div class="fv" id="farmUI"><button class="bbk" onclick="exitFarm()">â† Village</button>
  <div class="fbb"><button class="hab" onclick="harvestAll()">ğŸŒ¸ Harvest</button><button class="ffb" id="ffB" onclick="toggleFF()">â© 3x</button></div></div>
<div class="ss" id="seedSel"></div>
<div class="pov" id="purchO" onclick="if(event.target===this)closePurch()"><div class="pp" id="purchP"></div></div>
<div class="popup popup-ach" id="achPop"><div id="achE" style="font-size:38px"></div><div id="achT" style="font-weight:700;font-size:15px;color:#a08020;margin-top:5px"></div><div id="achS" style="font-size:11px;color:var(--tl);margin-top:3px"></div></div>
<div class="popup popup-lvl" id="lvlPop"><div style="font-weight:600;font-size:13px">LEVEL UP!</div><div id="lvlN" style="font-weight:700;font-size:34px;color:var(--ac3)"></div><div id="lvlU" style="font-size:11px;color:var(--tl);margin-top:4px"></div></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”Š AUDIO (unchanged)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ax=null,snd=true,mg=null,rg=null,rs=null,rf=null,amb=false;
function initA(){try{ax=new(window.AudioContext||window.webkitAudioContext)();mg=ax.createGain();mg.gain.value=.5;mg.connect(ax.destination)}catch(e){}}
function ensA(){if(!ax)initA();if(ax?.state==='suspended')ax.resume();if(!amb&&ax){startRain();amb=true;setInterval(()=>{if(G.weather.ri>.2&&Math.random()<G.weather.ri*.3)SFX.drop()},500)}}
document.addEventListener('click',ensA,{once:false});document.addEventListener('touchstart',ensA,{once:false});
function toggleSnd(){snd=!snd;document.getElementById('sndB').textContent=snd?'ğŸ”Š':'ğŸ”‡';if(mg)mg.gain.setTargetAtTime(snd?.5:0,ax.currentTime,.05)}
function tone(f,d,t='sine',v=.12){if(!ax||!snd)return;const o=ax.createOscillator(),g=ax.createGain();o.type=t;o.frequency.value=f;g.gain.setValueAtTime(v,ax.currentTime);g.gain.exponentialRampToValueAtTime(.001,ax.currentTime+d);o.connect(g);g.connect(mg);o.start();o.stop(ax.currentTime+d)}
function noise(d,v=.08,fq=4000){if(!ax||!snd)return;const sz=ax.sampleRate*d,b=ax.createBuffer(1,sz,ax.sampleRate),da=b.getChannelData(0);for(let i=0;i<sz;i++)da[i]=Math.random()*2-1;const s=ax.createBufferSource(),fl=ax.createBiquadFilter(),g=ax.createGain();s.buffer=b;fl.type='lowpass';fl.frequency.value=fq;g.gain.setValueAtTime(v,ax.currentTime);g.gain.exponentialRampToValueAtTime(.001,ax.currentTime+d);s.connect(fl);fl.connect(g);g.connect(mg);s.start()}
function startRain(){if(!ax)return;const d=4,sz=ax.sampleRate*d,b=ax.createBuffer(2,sz,ax.sampleRate);for(let c=0;c<2;c++){const da=b.getChannelData(c);let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;for(let i=0;i<sz;i++){const w=Math.random()*2-1;b0=.99886*b0+w*.0555179;b1=.99332*b1+w*.0750759;b2=.969*b2+w*.153852;b3=.8665*b3+w*.3104856;b4=.55*b4+w*.5329522;b5=-.7616*b5-w*.016898;da[i]=(b0+b1+b2+b3+b4+b5+b6+w*.5362)*.11;b6=w*.115926;if(Math.random()<.0003)da[i]+=(Math.random()-.5)*.3}}
rs=ax.createBufferSource();rs.buffer=b;rs.loop=true;rf=ax.createBiquadFilter();rf.type='bandpass';rf.frequency.value=800;rf.Q.value=.5;rg=ax.createGain();rg.gain.value=0;rs.connect(rf);rf.connect(rg);rg.connect(mg);rs.start()}
function updRainA(){if(!rg||!ax)return;rg.gain.setTargetAtTime(G.weather.ri*.35,ax.currentTime,.8)}
let lastCS=0;
const SFX={
  plant(){tone(180,.15);tone(260,.12);setTimeout(()=>tone(340,.18,'triangle',.08),60)},
  water(){noise(.2,.1,3000);tone(600,.15,'sine',.06)},
  harvest(){tone(523,.12,'triangle',.15);setTimeout(()=>tone(659,.12,'triangle',.12),70);setTimeout(()=>tone(784,.2,'triangle',.1),140)},
  coin(){tone(1200,.08,'square',.06);setTimeout(()=>tone(1600,.06,'square',.05),50);setTimeout(()=>tone(2000,.12,'sine',.06),90)},
  bouquet(){[392,494,587,698,784].forEach((f,i)=>setTimeout(()=>tone(f,.2,'triangle',.1-i*.015),i*80))},
  orderDone(){tone(523,.15,'triangle',.12);setTimeout(()=>tone(784,.15,'triangle',.1),240);setTimeout(()=>tone(1047,.3,'triangle',.12),360);setTimeout(()=>SFX.coin(),500)},
  upgrade(){noise(.06,.1,2000);setTimeout(()=>tone(600,.2,'triangle',.1),200)},
  unlock(){[262,330,392,523,659,784].forEach((f,i)=>setTimeout(()=>tone(f,.2,'triangle',.08),i*60))},
  thunder(){noise(.8,.2,200);tone(40,.8,'sine',.12)},damage(){tone(500,.15);setTimeout(()=>tone(300,.25,'triangle',.1),240)},
  purr(){if(!ax||!snd)return;const o1=ax.createOscillator(),o2=ax.createOscillator(),g=ax.createGain();o1.type='sine';o1.frequency.value=28;o2.type='sine';o2.frequency.value=32;g.gain.setValueAtTime(.08,ax.currentTime);g.gain.exponentialRampToValueAtTime(.001,ax.currentTime+1);o1.connect(g);o2.connect(g);g.connect(mg);o1.start();o2.start();o1.stop(ax.currentTime+1);o2.stop(ax.currentTime+1)},
  meow(){if(!ax||!snd)return;const o=ax.createOscillator(),g=ax.createGain();o.type='sine';o.frequency.setValueAtTime(500,ax.currentTime);o.frequency.linearRampToValueAtTime(900,ax.currentTime+.12);o.frequency.linearRampToValueAtTime(400,ax.currentTime+.4);g.gain.setValueAtTime(.001,ax.currentTime);g.gain.linearRampToValueAtTime(.08,ax.currentTime+.05);g.gain.exponentialRampToValueAtTime(.001,ax.currentTime+.4);o.connect(g);g.connect(mg);o.start();o.stop(ax.currentTime+.45)},
  click(){tone(800,.06,'sine',.06)},panelOpen(){tone(400,.08,'sine',.04);setTimeout(()=>tone(600,.1,'sine',.03),50)},
  panelClose(){tone(600,.08,'sine',.04)},expired(){tone(400,.2,'triangle',.08);setTimeout(()=>tone(300,.4,'triangle',.08),400)},
  newDay(){[523,659,784,1047].forEach((f,i)=>setTimeout(()=>tone(f,.3,'sine',.06),i*140))},
  sunny(){tone(880,.2,'sine',.05)},storm(){tone(80,.5,'sawtooth',.05)},
  levelUp(){[523,659,784,1047,1319,1568].forEach((f,i)=>setTimeout(()=>tone(f,.25,'triangle',.1-i*.013),i*90))},
  achieve(){tone(880,.15,'triangle',.12);setTimeout(()=>tone(1760,.3,'triangle',.08),240)},
  catFeed(){tone(400,.1);setTimeout(()=>tone(800,.15,'triangle',.06),160)},catPet(){tone(600,.08,'sine',.04);setTimeout(()=>tone(900,.12,'triangle',.04),60)},
  lucky(){tone(1047,.1,'triangle',.1);setTimeout(()=>tone(1568,.15,'triangle',.07),160);setTimeout(()=>tone(2093,.25,'sine',.05),240)},
  trans(){noise(.15,.05,3000)},ff(on){tone(on?600:1200,.08,'square',.05)},drop(){tone(2000+Math.random()*4000,.04,'sine',.02)},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š DATA (unchanged)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FL=[
  {id:0,nm:'Daisy',em:'ğŸŒ¼',sc:5,gt:15,sv:10,rt:'common',cl:'#f5e642',ul:1},
  {id:1,nm:'Tulip',em:'ğŸŒ·',sc:8,gt:20,sv:16,rt:'common',cl:'#ff6b8a',ul:1},
  {id:2,nm:'Sunflower',em:'ğŸŒ»',sc:12,gt:30,sv:25,rt:'common',cl:'#ffa726',ul:2},
  {id:3,nm:'Lavender',em:'ğŸ’œ',sc:15,gt:35,sv:30,rt:'uncommon',cl:'#b388ff',ul:4},
  {id:4,nm:'Rose',em:'ğŸŒ¹',sc:20,gt:45,sv:42,rt:'uncommon',cl:'#ef5350',ul:6},
  {id:5,nm:'Lily',em:'ğŸª·',sc:25,gt:50,sv:50,rt:'uncommon',cl:'#f8bbd0',ul:8},
  {id:6,nm:'Orchid',em:'ğŸª»',sc:35,gt:65,sv:75,rt:'rare',cl:'#ce93d8',ul:11},
  {id:7,nm:'Hydrangea',em:'ğŸ’™',sc:45,gt:80,sv:100,rt:'rare',cl:'#64b5f6',ul:14},
  {id:8,nm:'Cherry Blossom',em:'ğŸŒ¸',sc:60,gt:100,sv:140,rt:'epic',cl:'#f48fb1',ul:18},
  {id:9,nm:'Golden Lotus',em:'ğŸµï¸',sc:100,gt:130,sv:250,rt:'legendary',cl:'#ffd54f',ul:22},
];
const RCP=[
  {nm:'Sunshine Bundle',fl:{0:2,2:1},pr:90,ul:2},{nm:'Romance Bloom',fl:{4:2,5:1},pr:270,ul:8},
  {nm:'Lavender Dreams',fl:{3:3},pr:180,ul:5},{nm:'Spring Medley',fl:{1:1,0:1,3:1},pr:112,ul:4},
  {nm:'Royal Arrangement',fl:{6:1,4:1,8:1},pr:514,ul:15},{nm:'Golden Glory',fl:{9:1,6:1,7:1},pr:850,ul:22},
  {nm:'Village Charm',fl:'any5',pr:300,ul:10},{nm:'Rainbow Basket',fl:{0:1,1:1,4:1,6:1,7:1},pr:486,ul:14},
];
const FCOST=[0,100,250,500,1000];
const TOOLS=[
  {id:'wc',nm:'Watering Can',em:'ğŸ’§',mx:3,costs:[0,150,400],desc:['Click to water','Auto-water all','Auto + 10% growth'],ul:[1,5,12]},
  {id:'hb',nm:'Harvest Basket',em:'ğŸ§º',mx:3,costs:[0,200,500],desc:['One at a time','Harvest row','Harvest all'],ul:[1,7,15]},
  {id:'ss',nm:'Storm Shield',em:'ğŸ›¡ï¸',mx:2,costs:[0,300],desc:['No protection','Storm-proof'],ul:[1,9]},
  {id:'ft',nm:'Fertilizer',em:'ğŸ§ª',mx:3,costs:[0,250,600],desc:['Normal','+15% growth','+30% growth'],ul:[1,6,13]},
];
const WS=[{id:'rain',lb:'Rain',ic:'ğŸŒ§ï¸',gm:1.5,ri:1},{id:'drizzle',lb:'Drizzle',ic:'ğŸŒ¦ï¸',gm:1.25,ri:.4},{id:'sunny',lb:'Sunny',ic:'â˜€ï¸',gm:1,ri:0},{id:'storm',lb:'Storm',ic:'â›ˆï¸',gm:2,ri:1.8},{id:'fog',lb:'Fog',ic:'ğŸŒ«ï¸',gm:1,ri:.1}];
const CAT_FOOD=[{id:'fish',nm:'Fresh Fish',em:'ğŸŸ',cost:8,h:30,hp:5,tr:2},{id:'milk',nm:'Warm Milk',em:'ğŸ¥›',cost:5,h:15,hp:10,tr:1},{id:'treat',nm:'Fancy Treat',em:'ğŸ°',cost:15,h:10,hp:25,tr:5},{id:'tuna',nm:'Premium Tuna',em:'ğŸ£',cost:25,h:40,hp:15,tr:8}];
const CAT_ACC=[{id:'umbrella',nm:'Umbrella',em:'â˜‚ï¸',cost:50,ul:3},{id:'bow',nm:'Red Bow',em:'ğŸ€',cost:30,ul:2},{id:'hat',nm:'Tiny Hat',em:'ğŸ©',cost:80,ul:7},{id:'bell',nm:'Golden Bell',em:'ğŸ””',cost:120,ul:12},{id:'scarf',nm:'Cozy Scarf',em:'ğŸ§£',cost:60,ul:5},{id:'crown',nm:'Flower Crown',em:'ğŸ‘‘',cost:200,ul:18}];
const XP_TABLE=[];for(let i=0;i<30;i++)XP_TABLE.push(Math.floor(50+i*40+i*i*5));
const LV_UNLOCKS={2:'ğŸŒ» Sunflower seeds',3:'â˜‚ï¸ Cat umbrella',4:'ğŸ’œ Lavender',5:'ğŸ§ª Fertilizer Lv2',6:'ğŸŒ¹ Rose',7:'ğŸ§º Basket Lv2',8:'ğŸª· Lily + Romance Bloom',9:'ğŸ›¡ï¸ Storm Shield Lv2',10:'ğŸŒº Village Charm recipe',11:'ğŸª» Orchid',12:'âš¡ Watering Lv3',13:'ğŸ§ª Fertilizer Lv3',14:'ğŸ’™ Hydrangea',15:'ğŸ§º Basket Lv3',18:'ğŸŒ¸ Cherry Blossom',22:'ğŸµï¸ Golden Lotus'};
const ACHS=[
  {id:'first_harvest',nm:'First Bloom',em:'ğŸŒ¼',desc:'Harvest first flower',rw:25},
  {id:'first_bouquet',nm:'Bouquet Maker',em:'ğŸ’',desc:'Craft first bouquet',rw:50},
  {id:'first_order',nm:'Customer Service',em:'ğŸ“‹',desc:'Complete first order',rw:50},
  {id:'flowers_50',nm:'Green Thumb',em:'ğŸŒ¿',desc:'Harvest 50 flowers',rw:100},
  {id:'flowers_200',nm:'Master Gardener',em:'ğŸŒº',desc:'Harvest 200 flowers',rw:250},
  {id:'coins_1000',nm:'Prosperous',em:'ğŸ’°',desc:'Earn 1000 coins',rw:100},
  {id:'cat_feed_10',nm:'Cat Caretaker',em:'ğŸ±',desc:'Feed Mochi 10 times',rw:50},
  {id:'cat_trust_max',nm:'Cat Whisperer',em:'ğŸ’•',desc:'Max Mochi trust',rw:200},
  {id:'cat_gift',nm:'Mochi\'s Treasure',em:'ğŸ',desc:'Get gift from Mochi',rw:75},
  {id:'storm_5',nm:'Storm Survivor',em:'â›ˆï¸',desc:'Survive 5 storms',rw:100},
  {id:'all_farms',nm:'Land Baron',em:'ğŸ¡',desc:'Unlock all farms',rw:500},
  {id:'lucky_10',nm:'Lucky Star',em:'â­',desc:'10 lucky harvests',rw:150},
  {id:'level_10',nm:'Rising Star',em:'ğŸŒŸ',desc:'Reach level 10',rw:200},
  {id:'level_20',nm:'Village Hero',em:'ğŸ‘‘',desc:'Reach level 20',rw:500},
  {id:'day_7',nm:'Dedicated',em:'ğŸ”¥',desc:'Play 7 in-game days',rw:100},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ® STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mkP(){const p=[];for(let r=0;r<3;r++)for(let c=0;c<4;c++)p.push({fi:-1,pr:0,wet:false,dmg:false});return p}
const G={coins:250,day:1,dayT:0,tt:0,xp:0,level:1,inv:new Array(10).fill(0),
  farms:[{unlocked:true,plots:mkP()},{unlocked:false,plots:mkP()},{unlocked:false,plots:mkP()},{unlocked:false,plots:mkP()},{unlocked:false,plots:mkP()}],
  tools:{wc:1,hb:1,ss:1,ft:1},weather:WS[0],wT:0,wDur:70,stormCt:0,
  orders:[],oCd:0,bSlots:[],view:'village',cFarm:0,ff:false,time:0,
  cat:{x:0,y:0,tx:0,ty:0,hunger:80,happy:70,trust:10,acc:[],eq:[],mood:'idle',feedCt:0,petCt:0,giftT:0},
  player:{gx:4,gy:4},
  particles:[],stats:{harvested:0,coinsEarned:0,ordersCompleted:0,bouquetsMade:0,stormsWeathered:0,luckyHarvests:0,catFed:0,giftsRcvd:0,recipeCrafted:new Set()},
  achievements:new Set(),mx:0,my:0,ssOpen:false,sPlot:-1,activePanel:null,guidePage:0};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“· CAMERA SYSTEM (NEW!)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const cam={x:0,y:0,zoom:1,tx:0,ty:0,tz:1};
function camLerp(dt){
  const s=1-Math.pow(.05,dt);// smooth lerp
  cam.x+=(cam.tx-cam.x)*s;cam.y+=(cam.ty-cam.y)*s;
  cam.zoom+=(cam.tz-cam.zoom)*s}
function autoZoom(){
  if(G.view==='village'){
    // Calculate actual grid extent in world coords
    const tl=iso(0,0),br=iso(9,9),tr=iso(9,0),bl=iso(0,9);
    const minX=Math.min(tl.x,br.x,tr.x,bl.x)-TW;
    const maxX=Math.max(tl.x,br.x,tr.x,bl.x)+TW;
    const minY=Math.min(tl.y,br.y,tr.y,bl.y)-TH*3;
    const maxY=Math.max(tl.y,br.y,tr.y,bl.y)+TH*2;
    const gw=maxX-minX,gh=maxY-minY;
    // Available screen area (minus UI chrome)
    const aw=W*.92,ah=H*.7;// leave room for HUD + dock
    const scaleX=aw/gw,scaleY=ah/gh;
    cam.tz=Math.min(scaleX,scaleY,3);
    const mid=iso(4.5,4.5);cam.tx=mid.x;cam.ty=mid.y;
  }else{
    // Farm: top-down rectangular grid
    const totalW=FGRIDW+FPAD*2, totalH=FGRIDH+FPAD*2+40;
    const aw=W*.88,ah=H*.58;
    const scaleX=aw/totalW,scaleY=ah/totalH;
    cam.tz=Math.min(scaleX,scaleY,3.5);
    cam.tx=FGRIDW/2;cam.ty=FGRIDH/2;
  }}
// World â†’ Screen (through camera)
function w2s(wx,wy){return{x:(wx-cam.x)*cam.zoom+W/2,y:(wy-cam.y)*cam.zoom+H/2}}
// Screen â†’ World
function s2w(sx,sy){return{x:(sx-W/2)/cam.zoom+cam.x,y:(sy-H/2)/cam.zoom+cam.y}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ–¥ï¸ CANVAS + ISO ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const gc=document.getElementById('gc'),gx=gc.getContext('2d');
const rc=document.getElementById('rc'),rx=rc.getContext('2d');
let W,H,dpr;
var drops=[],MRD=200,puddles=[];
const TW=80,TH=40;// bigger tiles for detail
// Grid â†’ World (isometric projection, NO camera)
function iso(gxi,gyi){return{x:(gxi-gyi)*TW/2,y:(gxi+gyi)*TH/2}}
// World â†’ Grid (inverse)
function uniso(wx,wy){return{gx:wx/TW+wy/TH,gy:wy/TH-wx/TW}}
// Farm iso (local coords, 4 cols x 3 rows) â€” NOW TOP-DOWN GRID
const FPW=64,FPH=64,FGAP=10,FPAD=48;// plot size, gap, padding
const FGRIDW=4*(FPW+FGAP)-FGAP, FGRIDH=3*(FPH+FGAP)-FGAP;
function fgrid(c,r){return{x:c*(FPW+FGAP)+FPW/2, y:r*(FPH+FGAP)+FPH/2}}
function fiso(c,r){return fgrid(c,r)}// alias for compat

function resize(){dpr=window.devicePixelRatio||1;W=window.innerWidth;H=window.innerHeight;
  gc.width=W*dpr;gc.height=H*dpr;gc.style.width=W+'px';gc.style.height=H+'px';gx.setTransform(dpr,0,0,dpr,0,0);
  rc.width=W*dpr;rc.height=H*dpr;rc.style.width=W+'px';rc.style.height=H+'px';rx.setTransform(dpr,0,0,dpr,0,0);
  initPuddles();autoZoom();cam.x=cam.tx;cam.y=cam.ty;cam.zoom=cam.tz;initCatPos()}
window.addEventListener('resize',resize);resize();

// Draw isometric diamond
function drawTile(x,y,w,h,color){
  gx.fillStyle=color;gx.beginPath();
  gx.moveTo(x,y-h/2);gx.lineTo(x+w/2,y);gx.lineTo(x,y+h/2);gx.lineTo(x-w/2,y);gx.closePath();gx.fill()}
// Draw isometric box (3 faces)
function drawBox(cx,cy,w,h,d,topC,leftC,rightC){
  gx.fillStyle=topC;gx.beginPath();gx.moveTo(cx,cy-d-h/2);gx.lineTo(cx+w/2,cy-d);gx.lineTo(cx,cy-d+h/2);gx.lineTo(cx-w/2,cy-d);gx.closePath();gx.fill();
  gx.fillStyle=leftC;gx.beginPath();gx.moveTo(cx-w/2,cy-d);gx.lineTo(cx,cy-d+h/2);gx.lineTo(cx,cy+h/2);gx.lineTo(cx-w/2,cy);gx.closePath();gx.fill();
  gx.fillStyle=rightC;gx.beginPath();gx.moveTo(cx+w/2,cy-d);gx.lineTo(cx,cy-d+h/2);gx.lineTo(cx,cy+h/2);gx.lineTo(cx+w/2,cy);gx.closePath();gx.fill()}
function drawShadow(cx,cy,rx,ry){
  gx.fillStyle='rgba(30,20,10,.12)';gx.beginPath();gx.ellipse(cx,cy+2,rx,ry,.3,0,Math.PI*2);gx.fill()}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸŒ§ï¸ RAIN (screen space, parallax)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initPuddles(){puddles=[];for(let i=0;i<5;i++)puddles.push({x:Math.random()*W,y:H*.5+Math.random()*H*.35,r:12+Math.random()*20,t:Math.random()*100})}
function updRain(dt){const it=G.weather.ri,tg=Math.floor(MRD*Math.min(it,1.5));
  while(drops.length<tg)drops.push({x:Math.random()*W*1.2-W*.1,y:Math.random()*-H,s:400+Math.random()*300,l:8+Math.random()*12,o:.12+Math.random()*.15});
  while(drops.length>tg+10)drops.pop();
  for(const r of drops){r.y+=r.s*dt;r.x-=r.s*.1*dt;if(r.y>H+20){r.y=Math.random()*-60;r.x=Math.random()*W*1.2-W*.1}}
  for(const p of puddles)p.t+=dt*(1+it)}
function drawRain(){rx.clearRect(0,0,W,H);const it=G.weather.ri;if(it<=0)return;
  rx.strokeStyle='rgba(180,190,210,.25)';rx.lineWidth=1;
  for(const r of drops){rx.globalAlpha=r.o*Math.min(it,1);rx.beginPath();rx.moveTo(r.x,r.y);rx.lineTo(r.x-r.l*.1,r.y+r.l);rx.stroke()}
  // Rain splash particles on ground
  rx.globalAlpha=it*.3;rx.fillStyle='rgba(180,200,220,.3)';
  for(let i=0;i<drops.length;i+=4){const r=drops[i];if(r.y>H*.4){
    const sp=Math.sin(G.time*8+i)*.5+.5;
    rx.beginPath();rx.ellipse(r.x,r.y,2+sp*3,1+sp,0,0,Math.PI*2);rx.fill()}}
  // Puddles
  if(it>.3){rx.globalAlpha=it*.15;rx.fillStyle='rgba(140,160,200,.2)';
    for(const p of puddles){const ripple=Math.sin(p.t*2)*.4+.6;
      rx.beginPath();rx.ellipse(p.x,p.y,p.r*ripple,p.r*.4*ripple,.15,0,Math.PI*2);rx.fill();
      rx.strokeStyle='rgba(160,180,210,.15)';rx.lineWidth=.8;rx.stroke()}}
  rx.globalAlpha=1}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âœ¨ PARTICLES (world space)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addP(type,x,y,n=1){for(let i=0;i<n;i++)G.particles.push({type,x:x+(Math.random()-.5)*16,y:y+(Math.random()-.5)*8,vx:(Math.random()-.5)*35,vy:-25-Math.random()*40,life:1,ml:1+Math.random()*.5,sz:4+Math.random()*3,rot:Math.random()*6.28})}
function updParts(dt){for(let i=G.particles.length-1;i>=0;i--){const p=G.particles[i];p.x+=p.vx*dt;p.y+=p.vy*dt;p.vy+=45*dt;p.life-=dt;p.rot+=dt*2;if(p.life<=0)G.particles.splice(i,1)}}
function drawParts(){for(const p of G.particles){const a=Math.max(0,p.life/p.ml);gx.globalAlpha=a;gx.save();gx.translate(p.x,p.y);
  if(p.type==='heart'){gx.font=`${p.sz*2}px serif`;gx.textAlign='center';gx.fillText('â¤ï¸',0,0)}
  else if(p.type==='sparkle'){gx.fillStyle=`rgba(255,240,100,${a})`;gx.beginPath();gx.arc(0,0,p.sz*.6,0,Math.PI*2);gx.fill()}
  else if(p.type==='coin'){gx.font=`${p.sz*2}px serif`;gx.textAlign='center';gx.fillText('ğŸª™',0,0)}
  gx.restore()}gx.globalAlpha=1}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ˜ï¸ VILLAGE MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const VMAP=[
  [5,0,0,0,0,4,0,0,0,5],
  [0,0,1,1,1,1,1,0,0,0],
  [0,0,1,0,0,0,1,0,3,0],
  [5,0,1,2,0,2,1,0,0,5],
  [0,1,1,0,0,0,1,1,0,0],
  [0,1,0,2,0,0,0,1,0,0],
  [3,1,0,0,0,2,0,1,3,0],
  [0,1,1,1,0,0,1,1,0,0],
  [0,0,0,1,1,2,1,0,0,5],
  [5,0,0,0,0,0,0,0,5,0],
];
const FARM_POS=[{gx:3,gy:3},{gx:5,gy:3},{gx:3,gy:5},{gx:5,gy:8},{gx:5,gy:6}];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¨ DRAWING (all in world coords, camera applied at frame level)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawSky(){
  gx.save();gx.setTransform(dpr,0,0,dpr,0,0);// screen space
  const w=G.weather.id;let t,b;
  if(w==='sunny'){t='#6aaed8';b='#e8c878'}else if(w==='storm'){t='#4a4058';b='#7a6858'}else if(w==='fog'){t='#8a8898';b='#b0a898'}else if(w==='drizzle'){t='#7888b0';b='#c8a870'}else{t='#6878a0';b='#c09858'}
  const g=gx.createLinearGradient(0,0,0,H);g.addColorStop(0,t);g.addColorStop(.45,b);g.addColorStop(1,'#5a8838');gx.fillStyle=g;gx.fillRect(0,0,W,H);
  if(w==='sunny'){gx.fillStyle='rgba(255,240,180,.15)';gx.beginPath();gx.arc(W*.2,H*.12,80,0,Math.PI*2);gx.fill();
    gx.fillStyle='rgba(255,220,140,.08)';gx.beginPath();gx.arc(W*.2,H*.12,140,0,Math.PI*2);gx.fill()}
  const ca=w==='sunny'?'rgba(255,255,255,.2)':'rgba(180,175,195,.15)';gx.fillStyle=ca;
  for(let i=0;i<3;i++){const cx=((G.time*10+i*220)%(W+200))-100,cy=H*.06+i*20;
    gx.beginPath();gx.arc(cx,cy,22,0,Math.PI*2);gx.arc(cx+18,cy-6,15,0,Math.PI*2);gx.arc(cx+30,cy,18,0,Math.PI*2);gx.fill()}
  gx.restore()}

function drawGrassTile(sx,sy,seed){
  const c=seed%3===0?'#6a9a52':seed%3===1?'#5e9048':'#72a05a';drawTile(sx,sy,TW,TH,c);
  gx.fillStyle='rgba(90,160,60,.18)';
  for(let i=0;i<6;i++){const dx=(Math.sin(seed*7+i*3.7))*TW*.25,dy=(Math.cos(seed*5+i*2.3))*TH*.18;gx.fillRect(sx+dx-1,sy+dy-1,2,2)}
  gx.fillStyle='rgba(50,120,30,.1)';
  for(let i=0;i<4;i++){const dx=(Math.sin(seed*4+i*5.1))*TW*.2,dy=(Math.cos(seed*3+i*4.3))*TH*.14;gx.fillRect(sx+dx,sy+dy,1,3)}}
function drawPathTile(sx,sy){
  drawTile(sx,sy,TW,TH,'#c4a87a');
  gx.fillStyle='rgba(160,140,110,.2)';
  for(let i=0;i<6;i++){const dx=(Math.sin(sx*.1+i*2.5))*TW*.22,dy=(Math.cos(sy*.1+i*1.7))*TH*.16;
    gx.beginPath();gx.ellipse(sx+dx,sy+dy,3,1.8,.4+i*.2,0,Math.PI*2);gx.fill()}}
function drawFarmTile(sx,sy,fi,unlocked){
  if(unlocked){drawTile(sx,sy,TW,TH,'#8a6a40');
    gx.strokeStyle='rgba(100,75,45,.25)';gx.lineWidth=1;
    for(let i=-2;i<=2;i++){const ox=i*TW*.1;gx.beginPath();gx.moveTo(sx+ox-12,sy-2);gx.lineTo(sx+ox+12,sy+2);gx.stroke()}
    gx.strokeStyle='rgba(90,140,60,.35)';gx.lineWidth=1.5;
    gx.beginPath();gx.moveTo(sx,sy-TH/2);gx.lineTo(sx+TW/2,sy);gx.lineTo(sx,sy+TH/2);gx.lineTo(sx-TW/2,sy);gx.closePath();gx.stroke();
  }else{drawTile(sx,sy,TW,TH,'rgba(80,70,50,.35)');
    gx.strokeStyle='rgba(140,120,90,.3)';gx.lineWidth=1;gx.setLineDash([3,3]);
    gx.beginPath();gx.moveTo(sx,sy-TH/2);gx.lineTo(sx+TW/2,sy);gx.lineTo(sx,sy+TH/2);gx.lineTo(sx-TW/2,sy);gx.closePath();gx.stroke();gx.setLineDash([]);
    gx.font='14px serif';gx.textAlign='center';gx.fillText('ğŸ”’',sx,sy+2);
    gx.fillStyle='rgba(80,60,30,.5)';gx.beginPath();gx.roundRect(sx-18,sy+6,36,13,4);gx.fill();
    gx.fillStyle='rgba(255,240,200,.95)';gx.font='600 10px Fredoka';gx.fillText(`${FCOST[fi]}ğŸª™`,sx,sy+16)}}

function drawHouseISO(sx,sy){
  const bw=TW*.9,bh=TH*.9,bd=34;
  drawShadow(sx+8,sy+6,bw*.42,bh*.32);
  drawBox(sx,sy,bw,bh,bd,'#f0e0c8','#d8c8a8','#c8b898');
  const rh=22;
  gx.fillStyle='#c07050';gx.beginPath();gx.moveTo(sx-bw/2,sy-bd);gx.lineTo(sx,sy-bd-rh);gx.lineTo(sx+bw/2,sy-bd);gx.lineTo(sx,sy-bd+bh/2);gx.closePath();gx.fill();
  gx.fillStyle='#a86040';gx.beginPath();gx.moveTo(sx,sy-bd-rh);gx.lineTo(sx+bw/2,sy-bd);gx.lineTo(sx,sy-bd+bh/2);gx.closePath();gx.fill();
  gx.strokeStyle='rgba(80,40,20,.15)';gx.lineWidth=1;gx.beginPath();gx.moveTo(sx,sy-bd-rh);gx.lineTo(sx,sy-bd+bh/2);gx.stroke();
  // Window
  gx.fillStyle='#8a6040';gx.fillRect(sx-8,sy-bd+bh*.08-4,10,9);
  gx.fillStyle='rgba(255,220,120,.55)';gx.fillRect(sx-7,sy-bd+bh*.08-3,8,7);
  gx.strokeStyle='rgba(100,70,40,.3)';gx.lineWidth=.8;gx.beginPath();gx.moveTo(sx-3,sy-bd+bh*.08-3);gx.lineTo(sx-3,sy-bd+bh*.08+4);gx.stroke();
  gx.beginPath();gx.moveTo(sx-7,sy-bd+bh*.08+.5);gx.lineTo(sx+1,sy-bd+bh*.08+.5);gx.stroke();
  // Door
  gx.fillStyle='#8a6040';gx.fillRect(sx+bw*.08,sy-bd+bh*.2,7,13);
  gx.fillStyle='#f0c040';gx.beginPath();gx.arc(sx+bw*.08+5.5,sy-bd+bh*.2+8,1.2,0,Math.PI*2);gx.fill();
  // Chimney on roof
  drawBox(sx+bw*.22,sy-bd-rh*.45,7,3.5,12,'#888','#777','#666');
  if(Math.sin(G.time+sx)>.3){gx.fillStyle='rgba(200,200,200,.12)';
    gx.beginPath();gx.arc(sx+bw*.22,sy-bd-rh*.45-14+Math.sin(G.time*2)*2,3.5,0,Math.PI*2);gx.fill();
    gx.beginPath();gx.arc(sx+bw*.22-2,sy-bd-rh*.45-20+Math.sin(G.time*2.5)*2,2.8,0,Math.PI*2);gx.fill()}}

function drawShopISO(sx,sy){
  const bw=TW*1.1,bh=TH*1.1,bd=38;
  drawShadow(sx+8,sy+6,bw*.45,bh*.35);
  drawBox(sx,sy,bw,bh,bd,'#f8f0d8','#e8d8b8','#d8c8a8');
  gx.fillStyle='#e06050';gx.beginPath();gx.moveTo(sx-bw/2-3,sy-bd+2);gx.lineTo(sx,sy-bd-bh/2-3);gx.lineTo(sx+bw/2+3,sy-bd+2);gx.lineTo(sx,sy-bd+bh/2+3);gx.closePath();gx.fill();
  gx.strokeStyle='rgba(255,255,255,.3)';gx.lineWidth=1.5;
  for(let i=-2;i<=2;i++){const ox=i*bw*.1;gx.beginPath();gx.moveTo(sx+ox-bw*.15,sy-bd-1);gx.lineTo(sx+ox+bw*.15,sy-bd+5);gx.stroke()}
  gx.fillStyle='rgba(255,248,240,.92)';gx.fillRect(sx-16,sy-bd+bd*.28,32,14);
  gx.fillStyle='#8a6040';gx.font='bold 9px Fredoka';gx.textAlign='center';gx.fillText('ğŸŒº SHOP',sx,sy-bd+bd*.28+10)}

function drawTreeISO(sx,sy,variant){
  drawShadow(sx+5,sy+4,14,7);
  const tw=4,th=20;gx.fillStyle='#7a6040';gx.fillRect(sx-tw/2,sy-th,tw+1,th);
  gx.fillStyle='#6a5030';gx.fillRect(sx-tw/2,sy-th,tw/2,th);// dark side
  const sw=Math.sin(G.time*.7+variant*5)*2;
  gx.fillStyle='#4a8838';gx.beginPath();gx.arc(sx+sw,sy-26,16,0,Math.PI*2);gx.fill();
  gx.fillStyle='#5a9848';gx.beginPath();gx.arc(sx-7+sw,sy-19,12,0,Math.PI*2);gx.fill();
  gx.fillStyle='#48902e';gx.beginPath();gx.arc(sx+6+sw,sy-22,11,0,Math.PI*2);gx.fill();
  gx.fillStyle='rgba(120,180,80,.25)';gx.beginPath();gx.arc(sx-3+sw,sy-30,6,0,Math.PI*2);gx.fill();
  // Leaf dots
  gx.fillStyle='rgba(80,150,40,.15)';
  for(let i=0;i<4;i++){const a=i*1.5+variant;gx.beginPath();gx.arc(sx+Math.cos(a)*10+sw,sy-24+Math.sin(a)*6,2,0,Math.PI*2);gx.fill()}}

function drawFlowerPatchISO(sx,sy){
  drawTile(sx,sy,TW,TH,'#6a9a52');
  const colors=['#f5e642','#ff6b8a','#b388ff','#f8bbd0','#ffa726'];
  for(let i=0;i<6;i++){const dx=(Math.sin(sx*.1+i*3.1))*TW*.25,dy=(Math.cos(sy*.1+i*2.7))*TH*.2;
    gx.fillStyle=colors[i%5];gx.beginPath();gx.arc(sx+dx,sy+dy,2.5,0,Math.PI*2);gx.fill();
    gx.fillStyle='rgba(60,120,40,.4)';gx.beginPath();gx.arc(sx+dx,sy+dy+2.5,1.5,0,Math.PI*2);gx.fill()}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ‘¤ PLAYER + ğŸ± CAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCatPos(){const ps=iso(G.player.gx,G.player.gy);G.cat.x=ps.x+25;G.cat.y=ps.y+8;G.cat.tx=ps.x+25;G.cat.ty=ps.y+8}

function drawPlayer(sx,sy){
  const fy=sy+TH*.25;// feet at bottom of tile
  drawShadow(sx,fy+3,12,6);
  drawBox(sx,fy-8,14,7,18,'#6090d0','#5080c0','#4070b0');
  gx.fillStyle='#f0d0a0';gx.beginPath();gx.arc(sx,fy-30,8,0,Math.PI*2);gx.fill();
  gx.fillStyle='#6a4020';gx.beginPath();gx.arc(sx,fy-32,8,Math.PI,0);gx.fill();
  gx.fillStyle='#e0a060';gx.beginPath();gx.ellipse(sx,fy-34,10,4,0,0,Math.PI*2);gx.fill();
  drawBox(sx,fy-38,10,5,5,'#e0a060','#c89050','#b88040');
  gx.strokeStyle='#f0d0a0';gx.lineWidth=2.5;
  gx.beginPath();gx.moveTo(sx-7,fy-20);gx.lineTo(sx-12,fy-12);gx.stroke();
  gx.beginPath();gx.moveTo(sx+7,fy-20);gx.lineTo(sx+12,fy-12);gx.stroke();
  gx.fillStyle='#6a4020';gx.fillRect(sx-6,fy-1,5,3);gx.fillRect(sx+1,fy-1,5,3)}

function drawCatISO(cx,cy){
  if(G.weather.id==='storm'&&G.cat.mood==='hiding')return;
  const fy=cy+TH*.25;
  drawShadow(cx,fy+3,12,6);
  gx.fillStyle='#f0a840';gx.beginPath();gx.ellipse(cx,fy-8,14,8,0,0,Math.PI*2);gx.fill();
  gx.strokeStyle='#d09030';gx.lineWidth=1;
  for(let i=-1;i<=1;i++){gx.beginPath();gx.moveTo(cx+i*6,fy-14);gx.lineTo(cx+i*6,fy-3);gx.stroke()}
  gx.fillStyle='#f0a840';gx.beginPath();gx.arc(cx+10,fy-16,8,0,Math.PI*2);gx.fill();
  // Ears
  gx.beginPath();gx.moveTo(cx+4,fy-24);gx.lineTo(cx+9,fy-16);gx.lineTo(cx+1,fy-18);gx.closePath();gx.fill();
  gx.beginPath();gx.moveTo(cx+16,fy-24);gx.lineTo(cx+19,fy-18);gx.lineTo(cx+11,fy-16);gx.closePath();gx.fill();
  gx.fillStyle='#f0c0a0';
  gx.beginPath();gx.moveTo(cx+5,fy-22);gx.lineTo(cx+8.5,fy-17);gx.lineTo(cx+2.5,fy-18.5);gx.closePath();gx.fill();
  gx.beginPath();gx.moveTo(cx+15,fy-22);gx.lineTo(cx+17.5,fy-18.5);gx.lineTo(cx+11.5,fy-17);gx.closePath();gx.fill();
  // Eyes
  gx.fillStyle='#302018';
  if(G.cat.mood==='sunbathing'){gx.lineWidth=1.2;gx.strokeStyle='#302018';gx.beginPath();gx.arc(cx+7,fy-16,1.5,0,Math.PI);gx.stroke();gx.beginPath();gx.arc(cx+13,fy-16,1.5,0,Math.PI);gx.stroke()}
  else{gx.beginPath();gx.arc(cx+7,fy-16,1.8,0,Math.PI*2);gx.fill();gx.beginPath();gx.arc(cx+13,fy-16,1.8,0,Math.PI*2);gx.fill();
    gx.fillStyle='#fff';gx.beginPath();gx.arc(cx+7.5,fy-16.5,.7,0,Math.PI*2);gx.fill();gx.beginPath();gx.arc(cx+13.5,fy-16.5,.7,0,Math.PI*2);gx.fill()}
  gx.fillStyle='#e08080';gx.beginPath();gx.arc(cx+10,fy-13,1.3,0,Math.PI*2);gx.fill();
  gx.strokeStyle='#d07070';gx.lineWidth=.8;gx.beginPath();gx.moveTo(cx+10,fy-12);gx.lineTo(cx+8,fy-11);gx.stroke();gx.beginPath();gx.moveTo(cx+10,fy-12);gx.lineTo(cx+12,fy-11);gx.stroke();
  // Tail
  gx.strokeStyle='#f0a840';gx.lineWidth=2.8;gx.lineCap='round';gx.beginPath();gx.moveTo(cx-14,fy-8);gx.quadraticCurveTo(cx-20,fy-18,cx-17+Math.sin(G.time*3)*6,fy-24);gx.stroke();
  gx.fillStyle='#e09830';gx.fillRect(cx-7,fy-2,3.5,4);gx.fillRect(cx+5,fy-2,3.5,4);
  // Accessories
  if(G.cat.eq.includes('umbrella')&&G.weather.ri>0){gx.fillStyle='#e06060';gx.beginPath();gx.arc(cx+6,fy-32,15,Math.PI,0);gx.fill();gx.strokeStyle='#c04040';gx.lineWidth=1.5;gx.beginPath();gx.moveTo(cx+6,fy-32);gx.lineTo(cx+6,fy-20);gx.stroke()}
  if(G.cat.eq.includes('bow')){gx.fillStyle='#ff4060';gx.beginPath();gx.arc(cx+10,fy-4,3,0,Math.PI*2);gx.fill();gx.beginPath();gx.arc(cx+6,fy-3,2.2,0,Math.PI*2);gx.fill();gx.beginPath();gx.arc(cx+14,fy-3,2.2,0,Math.PI*2);gx.fill()}
  if(G.cat.eq.includes('hat')){gx.fillStyle='#3a3a3a';gx.fillRect(cx+5,fy-28,12,6);gx.fillRect(cx+2,fy-22.5,18,2.5)}
  if(G.cat.eq.includes('bell')){gx.fillStyle='#f0c040';gx.beginPath();gx.arc(cx+10,fy-2,2.8,0,Math.PI*2);gx.fill();gx.fillStyle='#d0a020';gx.beginPath();gx.arc(cx+10,fy-2,1,0,Math.PI*2);gx.fill()}
  if(G.cat.eq.includes('crown')){gx.fillStyle='#f0c040';gx.beginPath();gx.moveTo(cx+4,fy-24);gx.lineTo(cx+6,fy-29);gx.lineTo(cx+9,fy-25);gx.lineTo(cx+12,fy-30);gx.lineTo(cx+16,fy-24);gx.closePath();gx.fill();gx.fillStyle='#e06060';gx.beginPath();gx.arc(cx+10,fy-26,1.3,0,Math.PI*2);gx.fill()}
  if(G.cat.happy>80&&Math.sin(G.time*2)>.7){gx.globalAlpha=.6;gx.font='11px serif';gx.fillText('ğŸ’•',cx-2+Math.sin(G.time*3)*6,fy-34-Math.abs(Math.sin(G.time*2.5))*8);gx.globalAlpha=1}
  if(G.cat.hunger<15&&Math.sin(G.time*3)>.2){
    const bx=cx+22,by=fy-32;gx.fillStyle='rgba(255,248,240,.95)';gx.beginPath();gx.arc(bx,by,10,0,Math.PI*2);gx.fill();
    gx.strokeStyle='rgba(160,140,120,.3)';gx.lineWidth=1;gx.stroke();
    gx.font='12px serif';gx.textAlign='center';gx.fillText('ğŸŸ',bx,by+4)}
  // Nametag
  const ms=s2w(G.mx,G.my);const md=Math.sqrt((ms.x-cx)**2+(ms.y-cy)**2);
  if(md<50/cam.zoom){gx.fillStyle='rgba(255,248,240,.9)';const tw=54;gx.beginPath();gx.roundRect(cx-tw/2+5,fy-42,tw,16,7);gx.fill();
    gx.fillStyle='#8a6040';gx.font='600 10px Fredoka';gx.textAlign='center';gx.fillText('Mochi ğŸ±',cx+5,fy-30)}}

function updCat(dt){const c=G.cat,w=G.weather.id;
  c.hunger=Math.max(0,c.hunger-.15*dt*(G.ff?3:1));c.happy=Math.max(0,c.happy-.08*dt*(G.ff?3:1));
  if(c.hunger<20)c.happy=Math.max(0,c.happy-.2*dt*(G.ff?3:1));
  const dx=c.tx-c.x,dy=c.ty-c.y,dist=Math.sqrt(dx*dx+dy*dy);
  if(dist>3){c.x+=dx*2.5*dt;c.y+=dy*2.5*dt;c.mood='walking'}
  else{c.mood=c.hunger<15?'hungry':w==='storm'&&!c.eq.includes('umbrella')?'hiding':w==='sunny'?'sunbathing':'idle'}
  if(Math.random()<.003*dt*60&&w!=='storm'){
    if(G.view==='village'){const ps=iso(G.player.gx,G.player.gy);c.tx=ps.x+((Math.random()-.5)*70);c.ty=ps.y+((Math.random()-.5)*35)}
    else{c.tx+=(Math.random()-.5)*40;c.ty+=(Math.random()-.5)*20}}
  const ms=s2w(G.mx,G.my);const mdd=Math.sqrt((ms.x-c.x)**2+(ms.y-c.y)**2);
  if(mdd<50/cam.zoom){c.mood='curious';const now=performance.now();if(now-lastCS>4000){lastCS=now;Math.random()<.4?SFX.meow():SFX.purr()}}
  c.giftT+=dt*(G.ff?3:1);
  if(c.happy>70&&c.trust>30&&c.giftT>60&&Math.random()<.001*dt*60){c.giftT=0;
    const gi=Math.floor(Math.random()*3);
    if(gi===0){G.coins+=15;updUI();toast('ğŸ Mochi found 15ğŸª™!')}
    else if(gi===1){const fi=Math.floor(Math.random()*3);G.inv[fi]++;toast(`ğŸ Mochi found ${FL[fi].em}!`)}
    else{addXP(20);toast('ğŸ Mochi found â­20 XP!')}
    SFX.achieve();G.stats.giftsRcvd++;checkAch('cat_gift')}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸŒ¾ FARM VIEW RENDERING (TOP-DOWN STARDEW STYLE)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawFarmView(){
  drawSky();
  gx.save();
  gx.translate(W/2,H/2);gx.scale(cam.zoom,cam.zoom);gx.translate(-cam.x,-cam.y);
  const fi=G.cFarm,farm=G.farms[fi];
  const ox=-FPAD,oy=-FPAD,fw=FGRIDW+FPAD*2,fh=FGRIDH+FPAD*2;
  // â”€â”€â”€ Green grass background â”€â”€â”€
  gx.fillStyle='#5a9a38';gx.fillRect(ox,oy,fw,fh);
  // Grass texture dots
  gx.fillStyle='rgba(80,140,50,.3)';
  for(let i=0;i<60;i++){const gx2=ox+Math.sin(i*7.3)*fw*.48+fw/2,gy2=oy+Math.cos(i*5.1)*fh*.48+fh/2;
    gx.beginPath();gx.arc(gx2,gy2,1.5,0,Math.PI*2);gx.fill()}
  gx.fillStyle='rgba(100,170,60,.2)';
  for(let i=0;i<30;i++){const gx2=ox+((i*37+13)%fw),gy2=oy+((i*53+7)%fh);
    gx.fillRect(gx2,gy2,1,3)}
  // â”€â”€â”€ Dirt area behind plots â”€â”€â”€
  const dx=-12,dy=-12,dw=FGRIDW+24,dh=FGRIDH+24;
  gx.fillStyle='#c8a050';gx.beginPath();gx.roundRect(dx,dy,dw,dh,8);gx.fill();
  // Dirt texture
  gx.fillStyle='rgba(160,120,60,.2)';
  for(let i=0;i<40;i++){const px=dx+((i*29+5)%dw),py=dy+((i*41+11)%dh);
    gx.beginPath();gx.ellipse(px,py,2+Math.sin(i)*.8,1.2,.3*i,0,Math.PI*2);gx.fill()}
  gx.fillStyle='rgba(180,140,70,.15)';
  for(let i=0;i<25;i++){const px=dx+((i*43+9)%dw),py=dy+((i*31+17)%dh);
    gx.fillRect(px,py,1,1)}
  // â”€â”€â”€ Wooden fence â”€â”€â”€
  const fenceX=dx-6,fenceY=dy-6,fenceW=dw+12,fenceH=dh+12;
  // Fence posts (vertical)
  const postColor='#8a6a3a',darkPost='#6a5028',railColor='#a07840',darkRail='#7a5a2a';
  const postW=6,postH=16;
  for(let side=0;side<4;side++){
    const isH=side<2;// horizontal sides (top/bottom)
    const count=isH?6:5;
    for(let i=0;i<=count;i++){
      let px,py;
      if(side===0){px=fenceX+i*(fenceW/count);py=fenceY}// top
      else if(side===1){px=fenceX+i*(fenceW/count);py=fenceY+fenceH}// bottom
      else if(side===2){px=fenceX;py=fenceY+i*(fenceH/count)}// left
      else{px=fenceX+fenceW;py=fenceY+i*(fenceH/count)}// right
      // Post shadow
      gx.fillStyle='rgba(60,40,20,.15)';gx.fillRect(px-postW/2+2,py-2,postW,postH+2);
      // Post body
      gx.fillStyle=postColor;gx.fillRect(px-postW/2,py-postH/2,postW,postH);
      gx.fillStyle=darkPost;gx.fillRect(px-postW/2,py-postH/2,postW/2,postH);
      // Post cap
      gx.fillStyle='#9a7a48';gx.fillRect(px-postW/2-1,py-postH/2-2,postW+2,3);
    }
  }
  // Horizontal rails (top & bottom)
  for(const ry of [fenceY-2, fenceY+fenceH+2]){
    gx.fillStyle=railColor;gx.fillRect(fenceX,ry-2,fenceW,4);
    gx.fillStyle=darkRail;gx.fillRect(fenceX,ry,fenceW,2);
  }
  // Vertical rails (left & right)
  for(const rx of [fenceX-2, fenceX+fenceW+2]){
    gx.fillStyle=railColor;gx.fillRect(rx-2,fenceY,4,fenceH);
    gx.fillStyle=darkRail;gx.fillRect(rx,fenceY,2,fenceH);
  }
  // â”€â”€â”€ Plot grid (4Ã—3) â”€â”€â”€
  for(let r=0;r<3;r++){for(let c=0;c<4;c++){
    const pi=r*4+c,p=farm.plots[pi];
    const{x:cx,y:cy}=fgrid(c,r);
    const hw=FPW/2,hh=FPH/2;
    const left=cx-hw,top=cy-hh;
    // Store screen coords for click detection
    farm.plots[pi]._sx=cx;farm.plots[pi]._sy=cy;farm.plots[pi]._tw=FPW;farm.plots[pi]._th=FPH;
    if(p.dmg){
      // Damaged plot
      gx.fillStyle='#6a5a3a';gx.fillRect(left,top,FPW,FPH);
      gx.fillStyle='#5a4a2a';for(let i=0;i<3;i++)gx.fillRect(left+4,top+i*(FPH/3)+4,FPW-8,2);
      gx.font='22px serif';gx.textAlign='center';gx.textBaseline='middle';gx.fillText('ğŸ’€',cx,cy);
    }else if(p.fi>=0){
      // Tilled soil with crop
      const soilBase=p.wet?'#7a5a28':'#9a7a3a';
      const soilDark=p.wet?'#6a4a1a':'#8a6a2a';
      gx.fillStyle=soilBase;gx.fillRect(left,top,FPW,FPH);
      // Furrow lines (horizontal tilled rows)
      gx.fillStyle=soilDark;
      for(let i=0;i<5;i++){const fy=top+8+i*(FPH-16)/4;
        gx.fillRect(left+3,fy,FPW-6,3);
        gx.fillStyle='rgba(100,70,30,.15)';gx.fillRect(left+3,fy+3,FPW-6,1);gx.fillStyle=soilDark}
      // Soil edge shadow
      gx.fillStyle='rgba(60,40,15,.12)';gx.fillRect(left,top,FPW,2);gx.fillRect(left,top,2,FPH);
      gx.fillStyle='rgba(180,150,80,.1)';gx.fillRect(left,top+FPH-2,FPW,2);gx.fillRect(left+FPW-2,top,2,FPH);
      // Draw crop
      const fl=FL[p.fi],prog=p.pr;
      const pSeed=pi*7+fi*13,rotV=Math.sin(pSeed)*.05,scV=.92+Math.sin(pSeed+3)*.1;
      gx.save();gx.translate(cx,cy+hh*.3);gx.rotate(rotV);gx.scale(scV,scV);
      if(prog<.25){// Seeds just planted
        gx.fillStyle='#7a6030';gx.beginPath();gx.ellipse(0,0,6,3,0,0,Math.PI*2);gx.fill();
        gx.strokeStyle='#70a040';gx.lineWidth=1.5;gx.beginPath();gx.moveTo(0,0);gx.lineTo(0,-8);gx.stroke();
        gx.fillStyle='#80b848';gx.beginPath();gx.ellipse(-3,-8,3.5,2,.4,0,Math.PI*2);gx.fill();
        gx.beginPath();gx.ellipse(3,-9,3,1.8,-.4,0,Math.PI*2);gx.fill();
      }else if(prog<.5){// Sprout
        const sw=Math.sin(G.time*1.5+pi)*1.5;
        gx.strokeStyle='#509030';gx.lineWidth=2.5;gx.beginPath();gx.moveTo(0,0);gx.lineTo(sw,-20);gx.stroke();
        gx.fillStyle='#60a838';
        gx.beginPath();gx.ellipse(-6+sw,-13,8,3.5,.3,0,Math.PI*2);gx.fill();
        gx.beginPath();gx.ellipse(6+sw,-16,7,3,-.3,0,Math.PI*2);gx.fill();
        gx.fillStyle='#70b848';gx.beginPath();gx.ellipse(sw,-20,4,2,.1,0,Math.PI*2);gx.fill();
      }else if(prog<1){// Budding
        const sw=Math.sin(G.time*1.5+pi)*2;
        gx.strokeStyle='#408828';gx.lineWidth=3;gx.beginPath();gx.moveTo(0,0);gx.lineTo(sw,-28);gx.stroke();
        gx.fillStyle='#509830';
        gx.beginPath();gx.ellipse(-7+sw,-16,9,4,.4,0,Math.PI*2);gx.fill();
        gx.beginPath();gx.ellipse(7+sw,-20,8,3.5,-.3,0,Math.PI*2);gx.fill();
        gx.beginPath();gx.ellipse(-3+sw,-25,5,2.5,.2,0,Math.PI*2);gx.fill();
        // Bud
        gx.fillStyle=fl.cl+'88';gx.beginPath();gx.arc(sw,-30,6,0,Math.PI*2);gx.fill();
        gx.fillStyle=fl.cl+'44';gx.beginPath();gx.arc(sw,-30,3.5,0,Math.PI*2);gx.fill();
      }else{// Full bloom!
        const sw=Math.sin(G.time*1.2+pi)*3;
        gx.strokeStyle='#388020';gx.lineWidth=3;gx.beginPath();gx.moveTo(0,0);gx.lineTo(sw,-28);gx.stroke();
        gx.fillStyle='#48a028';
        gx.beginPath();gx.ellipse(-7+sw,-16,9,4,.4,0,Math.PI*2);gx.fill();
        gx.beginPath();gx.ellipse(7+sw,-20,8,3.5,-.3,0,Math.PI*2);gx.fill();
        gx.beginPath();gx.ellipse(-3+sw,-25,5,2.5,.2,0,Math.PI*2);gx.fill();
        // Flower head
        const fhx=sw,fhy=-34;gx.fillStyle=fl.cl;
        for(let pp=0;pp<6;pp++){const a=pp*Math.PI/3+G.time*.2;
          gx.beginPath();gx.ellipse(fhx+Math.cos(a)*6,fhy+Math.sin(a)*6,6,3.5,a,0,Math.PI*2);gx.fill()}
        gx.fillStyle='#f8e860';gx.beginPath();gx.arc(fhx,fhy,4,0,Math.PI*2);gx.fill();
        // Sparkles
        if(Math.sin(G.time*4+pi*2)>.6){gx.fillStyle='rgba(255,255,200,.8)';
          for(let s=0;s<4;s++){const a=s*Math.PI/2+G.time*3;
            gx.beginPath();gx.arc(fhx+Math.cos(a)*10,fhy+Math.sin(a)*10,2,0,Math.PI*2);gx.fill()}}}
      gx.restore();
      // Progress bar
      if(prog<1){const bw=FPW*.7,bh=5;const barX=cx-bw/2,barY=cy+hh+4;
        gx.fillStyle='rgba(0,0,0,.3)';gx.beginPath();gx.roundRect(barX,barY,bw,bh,2);gx.fill();
        gx.fillStyle='#70c040';gx.beginPath();gx.roundRect(barX,barY,bw*prog,bh,2);gx.fill()}
    }else{
      // Empty plot â€” tilled soil waiting for seeds
      const emptyBase=(r+c)%2===0?'#b8983c':'#b09038';
      gx.fillStyle=emptyBase;gx.fillRect(left,top,FPW,FPH);
      // Lighter furrow lines
      gx.fillStyle='rgba(160,130,60,.2)';
      for(let i=0;i<5;i++){const fy=top+8+i*(FPH-16)/4;gx.fillRect(left+3,fy,FPW-6,2)}
      // Border
      gx.strokeStyle='rgba(140,110,50,.3)';gx.lineWidth=1;gx.strokeRect(left+.5,top+.5,FPW-1,FPH-1);
      // Plus marker
      gx.strokeStyle='rgba(180,160,100,.5)';gx.lineWidth=2;
      gx.beginPath();gx.moveTo(cx-8,cy);gx.lineTo(cx+8,cy);gx.stroke();
      gx.beginPath();gx.moveTo(cx,cy-8);gx.lineTo(cx,cy+8);gx.stroke()}
  }}
  // â”€â”€â”€ Decorative elements around farm â”€â”€â”€
  // Small flowers in grass
  const decoColors=['#f5e642','#ff6b8a','#b388ff','#ffa726','#f8bbd0'];
  for(let i=0;i<12;i++){
    const angle=i*Math.PI*2/12,radius=Math.max(FGRIDW,FGRIDH)/2+FPAD*.65;
    const fx=FGRIDW/2+Math.cos(angle+fi*.5)*radius*(1+Math.sin(i*2.3)*.2);
    const fy=FGRIDH/2+Math.sin(angle+fi*.5)*radius*(1+Math.cos(i*1.7)*.2);
    gx.fillStyle=decoColors[i%5];gx.beginPath();gx.arc(fx,fy,3,0,Math.PI*2);gx.fill();
    gx.fillStyle='rgba(60,100,30,.4)';gx.fillRect(fx-.5,fy+3,1,4)}
  // Small rocks
  for(let i=0;i<5;i++){
    const rx2=ox+15+((i*67+23)%fw),ry2=oy+15+((i*89+31)%fh);
    if(rx2>dx&&rx2<dx+dw&&ry2>dy&&ry2<dy+dh)continue;// skip if inside dirt
    gx.fillStyle='#8a8878';gx.beginPath();gx.ellipse(rx2,ry2,4+Math.sin(i)*2,3,.2*i,0,Math.PI*2);gx.fill();
    gx.fillStyle='#9a9888';gx.beginPath();gx.ellipse(rx2-1,ry2-1,2,1.5,.2*i,0,Math.PI*2);gx.fill()}
  // Cat
  drawCatISO(G.cat.x,G.cat.y);
  drawParts();
  gx.restore();
  // Farm label (screen space)
  gx.fillStyle='rgba(255,248,240,.85)';gx.font='600 14px Fredoka';gx.textAlign='center';
  gx.fillText(`ğŸŒ¾ Farm ${fi+1}`,W/2,H*.08)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ˜ï¸ VILLAGE VIEW RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawVillage(){
  drawSky();
  gx.save();
  gx.translate(W/2,H/2);gx.scale(cam.zoom,cam.zoom);gx.translate(-cam.x,-cam.y);
  const renderList=[];
  for(let gy=0;gy<10;gy++){for(let gxi=0;gxi<10;gxi++){
    const{x:sx,y:sy}=iso(gxi,gy);const tile=VMAP[gy][gxi];
    renderList.push({gx:gxi,gy,sx,sy,tile,depth:gxi+gy})}}
  const ps=iso(G.player.gx,G.player.gy);
  renderList.push({type:'player',sx:ps.x,sy:ps.y,depth:G.player.gx+G.player.gy+.6});
  const catG=uniso(G.cat.x,G.cat.y);
  renderList.push({type:'cat',sx:G.cat.x,sy:G.cat.y,depth:catG.gx+catG.gy+.55});
  renderList.sort((a,b)=>a.depth-b.depth);
  for(const item of renderList){
    if(item.type==='player'){drawPlayer(item.sx,item.sy);continue}
    if(item.type==='cat'){drawCatISO(item.sx,item.sy);continue}
    const{gx:tgx,gy:tgy,sx,sy,tile}=item;
    switch(tile){
      case 0:case 7:drawGrassTile(sx,sy,tgx*10+tgy);if(tile===7)drawFlowerPatchISO(sx,sy);break;
      case 1:drawPathTile(sx,sy);break;
      case 2:{const fi=FARM_POS.findIndex(f=>f.gx===tgx&&f.gy===tgy);
        if(fi>=0)drawFarmTile(sx,sy,fi,G.farms[fi].unlocked);else drawGrassTile(sx,sy,tgx*10+tgy);break}
      case 3:drawGrassTile(sx,sy,tgx*10+tgy);drawHouseISO(sx,sy-TH*.1);break;
      case 4:drawGrassTile(sx,sy,tgx*10+tgy);drawShopISO(sx,sy-TH*.15);break;
      case 5:drawGrassTile(sx,sy,tgx*10+tgy);drawTreeISO(sx,sy-TH*.05,tgx+tgy);break;
      case 6:drawTile(sx,sy,TW,TH,'#5a90b0');break;
      default:drawGrassTile(sx,sy,tgx*10+tgy)}}
  for(let fi=0;fi<5;fi++){const fp=FARM_POS[fi],{x:sx,y:sy}=iso(fp.gx,fp.gy);
    if(G.farms[fi].unlocked){gx.fillStyle='rgba(255,248,240,.7)';gx.font='600 10px Fredoka';gx.textAlign='center';gx.fillText(`Farm ${fi+1}`,sx,sy+TH*.6)}}
  drawParts();
  gx.restore()}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš™ï¸ GAME LOGIC (unchanged)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updWeather(dt){G.wT+=dt*(G.ff?3:1);if(G.wT>=G.wDur){G.wT=0;G.wDur=50+Math.random()*60;
  let nw;if(G.stormCt>=2){nw=WS[Math.floor(Math.random()*3)];G.stormCt=0}
  else{const r=Math.random();nw=r<.25?WS[0]:r<.45?WS[1]:r<.7?WS[2]:r<.88?WS[3]:WS[4]}
  if(nw.id==='storm'){G.stormCt++;SFX.storm();G.stats.stormsWeathered++;checkAch('storm_5')}else if(nw.id==='sunny')SFX.sunny();
  G.weather=nw;updUI();updRainA()}}
function updGrowth(dt){const mul=G.weather.gm*(1+(G.tools.ft-1)*.15)*(G.level>=25?1.5:1);
  for(const farm of G.farms){if(!farm.unlocked)continue;
    for(const p of farm.plots){if(p.fi<0||p.dmg)continue;
      let gm=mul;if(p.wet)gm*=1.1;p.pr=Math.min(1,p.pr+dt*(G.ff?3:1)/FL[p.fi].gt*gm)}}}
let stormT=0;
function updStorm(dt){if(G.weather.id!=='storm')return;stormT+=dt*(G.ff?3:1);
  if(stormT>3+Math.random()*5){stormT=0;SFX.thunder();
    if(G.tools.ss<2){for(const farm of G.farms){if(!farm.unlocked)continue;
      for(const p of farm.plots){if(p.fi>=0&&!p.dmg&&Math.random()<.04){p.dmg=true;SFX.damage()}}}}}}
function updDay(dt){G.dayT+=dt*(G.ff?3:1);G.tt+=dt*(G.ff?3:1);
  if(G.dayT>=120){G.dayT=0;G.day++;SFX.newDay();updUI();checkAch('day_7');
    if(G.tools.wc>=2){for(const farm of G.farms){if(!farm.unlocked)continue;for(const p of farm.plots)if(p.fi>=0&&!p.dmg)p.wet=true}}
    const hasAssets=G.farms.some(f=>f.unlocked&&f.plots.some(p=>p.fi>=0))||G.inv.some(n=>n>0);
    if(G.coins<5&&!hasAssets){G.coins+=50;updUI();toast('ğŸ’ Village fund: +50ğŸª™')}}}
function updOrders(dt){for(let i=G.orders.length-1;i>=0;i--){
  G.orders[i].t-=dt*(G.ff?3:1);if(G.orders[i].t<=0){G.orders.splice(i,1);SFX.expired();toast('â° Order expired!')}}
  G.oCd-=dt*(G.ff?3:1);if(G.orders.length<3&&G.oCd<=0){G.oCd=12;genOrder()}}
function genOrder(){
  const mxT=Math.min(Math.floor(1+G.farms.filter(f=>f.unlocked).length*1.5+G.day*.3),9);
  if(Math.random()<.65){const fi=Math.floor(Math.random()*(mxT+1));if(FL[fi].ul>G.level)return;
    const ct=1+Math.floor(Math.random()*3);const tl=90+ct*25+fi*10;
    G.orders.push({type:'flower',desc:`${ct}Ã— ${FL[fi].em} ${FL[fi].nm}`,req:{[fi]:ct},rw:Math.floor(FL[fi].sv*ct*1.2),tl,t:tl})}
  else{const avail=RCP.filter(r=>r.ul<=G.level);if(!avail.length)return;
    const r=avail[Math.floor(Math.random()*avail.length)];
    G.orders.push({type:'bouquet',desc:`ğŸ“¦ ${r.nm}`,req:{recipe:RCP.indexOf(r)},rw:Math.floor(r.pr*1.3),tl:180,t:180})}}

// XP + Levels + Achievements (unchanged)
function addXP(n){G.xp+=n;while(G.xp>=XP_TABLE[G.level-1]&&G.level<30){G.xp-=XP_TABLE[G.level-1];G.level++;
  SFX.levelUp();const p=document.getElementById('lvlPop');document.getElementById('lvlN').textContent=G.level;
  document.getElementById('lvlU').textContent=LV_UNLOCKS[G.level]||'';p.classList.add('show');setTimeout(()=>p.classList.remove('show'),2500);
  if(G.level>=10)checkAch('level_10');if(G.level>=20)checkAch('level_20')}updUI()}
function checkAch(id){if(G.achievements.has(id))return;
  const a=ACHS.find(a=>a.id===id);if(!a)return;let earned=false;
  switch(id){
    case'first_harvest':earned=G.stats.harvested>=1;break;case'first_bouquet':earned=G.stats.bouquetsMade>=1;break;
    case'first_order':earned=G.stats.ordersCompleted>=1;break;case'flowers_50':earned=G.stats.harvested>=50;break;
    case'flowers_200':earned=G.stats.harvested>=200;break;case'coins_1000':earned=G.stats.coinsEarned>=1000;break;
    case'cat_feed_10':earned=G.stats.catFed>=10;break;case'cat_trust_max':earned=G.cat.trust>=100;break;
    case'cat_gift':earned=G.stats.giftsRcvd>=1;break;case'storm_5':earned=G.stats.stormsWeathered>=5;break;
    case'all_farms':earned=G.farms.every(f=>f.unlocked);break;
    case'lucky_10':earned=G.stats.luckyHarvests>=10;break;
    case'level_10':earned=G.level>=10;break;case'level_20':earned=G.level>=20;break;
    case'day_7':earned=G.day>=7;break;default:return}
  if(!earned)return;G.achievements.add(id);SFX.achieve();G.coins+=a.rw;addXP(Math.floor(a.rw/2));
  const p=document.getElementById('achPop');document.getElementById('achE').textContent=a.em;
  document.getElementById('achT').textContent=a.nm;document.getElementById('achS').textContent=`+${a.rw}ğŸª™ +${Math.floor(a.rw/2)}â­`;
  p.classList.add('show');setTimeout(()=>p.classList.remove('show'),2800);updUI()}

// Actions (unchanged)
function plantSeed(fi){if(G.sPlot<0)return;const farm=G.farms[G.cFarm],p=farm.plots[G.sPlot];
  if(p.fi>=0||p.dmg)return;const fl=FL[fi];if(G.coins<fl.sc||fl.ul>G.level)return;
  G.coins-=fl.sc;p.fi=fi;p.pr=0;p.wet=false;SFX.plant();closeSeedSel();updUI()}
function harvestPlot(pi){const farm=G.farms[G.cFarm],p=farm.plots[pi];
  if(p.dmg){p.dmg=false;p.fi=-1;p.pr=0;SFX.click();return}
  if(p.fi<0||p.pr<1)return;const fl=FL[p.fi];
  const lucky=Math.random()<(G.cat.happy>70?.15:.05);
  const ct=lucky?2:1;G.inv[p.fi]+=ct;G.stats.harvested+=ct;
  addXP(Math.floor(fl.sv/2));SFX.harvest();addP('sparkle',p._sx,p._sy-10,3);
  if(lucky){SFX.lucky();G.stats.luckyHarvests++;toast(`ğŸ€ Lucky! 2Ã— ${fl.em}!`);checkAch('lucky_10')}
  p.fi=-1;p.pr=0;p.wet=false;checkAch('first_harvest');checkAch('flowers_50');checkAch('flowers_200');updUI()}
function harvestAll(){const farm=G.farms[G.cFarm];for(let i=0;i<12;i++)if(farm.plots[i].fi>=0&&farm.plots[i].pr>=1)harvestPlot(i)}
function sellFlower(fi){if(G.inv[fi]<=0)return;G.inv[fi]--;const v=FL[fi].sv;G.coins+=v;G.stats.coinsEarned+=v;SFX.coin();checkAch('coins_1000');updUI()}
function fulfillOrder(oi){const o=G.orders[oi];if(!o)return;
  if(o.type==='flower'){for(const[fi,ct]of Object.entries(o.req)){if(G.inv[fi]<ct)return}for(const[fi,ct]of Object.entries(o.req))G.inv[fi]-=ct}
  else{const ri=o.req.recipe,r=RCP[ri];if(!canCraftRecipe(r))return;deductRecipe(r)}
  G.coins+=o.rw;G.stats.coinsEarned+=o.rw;G.stats.ordersCompleted++;addXP(15+Math.floor(o.rw/10));
  SFX.orderDone();addP('coin',W/2,H/2,5);G.orders.splice(oi,1);checkAch('first_order');checkAch('coins_1000');updUI()}
function canCraftRecipe(r){if(r.fl==='any5'){let ct=0;for(let i=0;i<10;i++)if(G.inv[i]>0)ct++;return ct>=5}
  for(const[fi,ct]of Object.entries(r.fl))if(G.inv[fi]<ct)return false;return true}
function deductRecipe(r){if(r.fl==='any5'){let ct=0;for(let i=0;i<10;i++){if(G.inv[i]>0&&ct<5){G.inv[i]--;ct++}}}
  else{for(const[fi,ct]of Object.entries(r.fl))G.inv[fi]-=ct}}
function craftBouquet(ri){const r=RCP[ri];if(r.ul>G.level||!canCraftRecipe(r))return;
  deductRecipe(r);G.coins+=r.pr;G.stats.coinsEarned+=r.pr;G.stats.bouquetsMade++;
  G.stats.recipeCrafted.add(ri);addXP(Math.floor(r.pr/8)+10);SFX.bouquet();addP('sparkle',W/2,H/2,5);
  checkAch('first_bouquet');checkAch('coins_1000');updUI()}
function upgradeTool(tid){const t=TOOLS.find(t=>t.id===tid);if(!t)return;
  const cl=G.tools[tid],nl=cl+1;if(nl>t.mx)return;
  const cost=t.costs[cl];if(G.coins<cost||t.ul[cl]>G.level)return;
  G.coins-=cost;G.tools[tid]=nl;SFX.upgrade();addXP(20);updUI()}
function feedCat(fid){const f=CAT_FOOD.find(f=>f.id===fid);if(!f||G.coins<f.cost)return;
  G.coins-=f.cost;const c=G.cat;c.hunger=Math.min(100,c.hunger+f.h);c.happy=Math.min(100,c.happy+f.hp);
  c.trust=Math.min(100,c.trust+f.tr);c.feedCt++;G.stats.catFed++;
  SFX.catFeed();addP('heart',G.cat.x,G.cat.y-15,2);checkAch('cat_feed_10');checkAch('cat_trust_max');updUI()}
function petCat(){const c=G.cat;c.happy=Math.min(100,c.happy+3);c.trust=Math.min(100,c.trust+.5);c.petCt++;
  addXP(1);SFX.catPet();addP('heart',c.x,c.y-15,3);checkAch('cat_trust_max');updUI()}
function buyCatAcc(aid){const a=CAT_ACC.find(a=>a.id===aid);if(!a||G.coins<a.cost||a.ul>G.level||G.cat.acc.includes(aid))return;
  G.coins-=a.cost;G.cat.acc.push(aid);G.cat.eq.push(aid);SFX.unlock();updUI()}
function toggleCatAcc(aid){if(!G.cat.acc.includes(aid))return;const i=G.cat.eq.indexOf(aid);if(i>=0)G.cat.eq.splice(i,1);else G.cat.eq.push(aid);SFX.click()}
function buyFarm(fi){if(G.coins<FCOST[fi]||G.farms[fi].unlocked)return;G.coins-=FCOST[fi];G.farms[fi].unlocked=true;SFX.unlock();checkAch('all_farms');updUI()}
function toggleFF(){G.ff=!G.ff;SFX.ff(G.ff);document.getElementById('ffB').classList.toggle('on',G.ff)}
function enterFarm(fi){if(!G.farms[fi].unlocked)return;G.cFarm=fi;G.view='farm';
  document.getElementById('farmUI').style.display='block';document.getElementById('dock').style.display='none';
  autoZoom();cam.tx=FGRIDW/2;cam.ty=FGRIDH/2;
  G.cat.x=FGRIDW+FPAD*.5;G.cat.y=FGRIDH+FPAD*.3;G.cat.tx=G.cat.x;G.cat.ty=G.cat.y;SFX.trans()}
function exitFarm(){G.view='village';document.getElementById('farmUI').style.display='none';
  document.getElementById('dock').style.display='flex';autoZoom();initCatPos();SFX.trans();closeSeedSel()}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“± UI PANELS (unchanged)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updUI(){
  document.getElementById('coins').textContent=G.coins;document.getElementById('lvl').textContent=G.level;
  document.getElementById('dayN').textContent=G.day;document.getElementById('wI').textContent=G.weather.ic;
  document.getElementById('wL').textContent=G.weather.lb;
  const xpN=XP_TABLE[Math.min(G.level-1,29)];document.getElementById('xpF').style.width=(G.xp/xpN*100)+'%'}
function op(panel){G.activePanel=panel;SFX.panelOpen();
  const c=document.getElementById('panelC');let h='<div class="ph"></div>';
  switch(panel){
  case'shop':h+=`<h2>ğŸŒ± Seed Shop</h2><button class="pc" onclick="cp()">âœ•</button><div class="sg">`;
    for(const fl of FL){const locked=fl.ul>G.level;h+=`<div class="si${locked?' locked':''}" onclick="sellFL_shop(${fl.id})">
      <span class="fi">${fl.em}</span><div class="fn">${fl.nm}</div><div class="fc">${fl.sc}ğŸª™</div>
      <div class="rt ${fl.rt}">${fl.rt}</div>${locked?`<div class="ft">ğŸ”’ Lv${fl.ul}</div>`:''}</div>`}
    h+='</div>';break;
  case'bouquet':h+=`<h2>ğŸ’ Bouquet Crafting</h2><button class="pc" onclick="cp()">âœ•</button>`;
    for(let ri=0;ri<RCP.length;ri++){const r=RCP[ri];const locked=r.ul>G.level;const can=!locked&&canCraftRecipe(r);
      h+=`<div class="oc" style="opacity:${locked?.35:1}"><div style="font-weight:600;font-size:13px">${locked?'ğŸ”’ ':''} ${r.nm}</div><div style="font-size:10px;color:var(--tl);margin:3px 0">`;
      if(r.fl==='any5')h+='Any 5 different flowers';else for(const[fi,ct]of Object.entries(r.fl))h+=`${ct}Ã— ${FL[fi].em} `;
      h+=`</div><div class="br"><span class="price">${r.pr}ğŸª™</span></div>${can?`<button class="fb" onclick="craftBouquet(${ri});op('bouquet')">Craft & Sell</button>`:''}</div>`}break;
  case'orders':h+=`<h2>ğŸ“‹ Orders</h2><button class="pc" onclick="cp()">âœ•</button>`;
    if(!G.orders.length)h+='<div class="et">No orders yet... wait a moment!</div>';
    for(let i=0;i<G.orders.length;i++){const o=G.orders[i];const tl=Math.ceil(o.t),col=tl<30?'var(--dn)':tl<60?'var(--ac)':'var(--ac2)';
      h+=`<div class="oc"><div style="font-weight:600;font-size:13px">${o.desc}</div><div class="tm" style="color:${col}">${tl}s</div>
        <div style="font-size:11px;margin-top:4px">Reward: <b style="color:#b8860b">${o.rw}ğŸª™</b></div>`;
      let can=true;if(o.type==='flower'){for(const[fi,ct]of Object.entries(o.req))if(G.inv[fi]<ct)can=false}else{const r=RCP[o.req.recipe];can=canCraftRecipe(r)}
      h+=`<button class="fb" onclick="fulfillOrder(${i});op('orders')" ${can?'':'disabled'}>${can?'âœ… Fulfill':'Need more items'}</button></div>`}break;
  case'tools':h+=`<h2>ğŸ”§ Tools</h2><button class="pc" onclick="cp()">âœ•</button>`;
    for(const t of TOOLS){const cl=G.tools[t.id],mx=cl>=t.mx;const nl=cl+1,cost=mx?0:t.costs[cl],canUP=!mx&&G.coins>=cost&&(t.ul[cl]||0)<=G.level;
      h+=`<div class="tc"><div class="ti">${t.em}</div><div class="tinf"><div class="tn">${t.nm}</div><div class="td">${t.desc[cl-1]}</div>
        <div class="tl">Lv ${cl}/${t.mx}</div></div>${mx?'<button class="ub mx" disabled>MAX</button>':
        `<button class="ub" onclick="upgradeTool('${t.id}');op('tools')" ${canUP?'':'disabled'}>${cost}ğŸª™ â†’ Lv${nl}</button>`}</div>`}break;
  case'cat':h+=`<h2>ğŸ± Mochi</h2><button class="pc" onclick="cp()">âœ•</button>`;
    const cc=G.cat;h+=`<div class="cat-card"><div style="font-size:32px">ğŸ±</div><div style="flex:1">
      <div style="font-size:10px;color:var(--tl)">Hunger</div><div class="meter mh"><div class="meter-fill" style="width:${cc.hunger}%"></div></div>
      <div style="font-size:10px;color:var(--tl)">Happiness</div><div class="meter mp"><div class="meter-fill" style="width:${cc.happy}%"></div></div>
      <div style="font-size:10px;color:var(--tl)">Trust</div><div class="meter mt"><div class="meter-fill" style="width:${cc.trust}%"></div></div>
      <div style="font-size:9px;color:var(--tl);margin-top:2px">Mood: ${cc.mood}</div></div></div>`;
    h+=`<div class="sl">ğŸ½ï¸ Feed Mochi</div>`;
    for(const f of CAT_FOOD){h+=`<div class="cat-food" onclick="feedCat('${f.id}');op('cat')"><span style="font-size:20px">${f.em}</span><div style="flex:1"><div style="font-weight:600;font-size:12px">${f.nm}</div>
      <div style="font-size:9px;color:var(--tl)">+${f.h}hunger +${f.hp}happy +${f.tr}trust</div></div><div style="font-weight:600;font-size:12px;color:#b8860b">${f.cost}ğŸª™</div></div>`}
    h+=`<div class="sl">ğŸ€ Accessories</div><div style="display:flex;flex-wrap:wrap;gap:3px">`;
    for(const a of CAT_ACC){const owned=cc.acc.includes(a.id),eq=cc.eq.includes(a.id),locked=a.ul>G.level;
      h+=`<div class="cat-acc${eq?' eq':''}" onclick="${owned?`toggleCatAcc('${a.id}');op('cat')`:`buyCatAcc('${a.id}');op('cat')`}" style="${locked?'opacity:.35;pointer-events:none':''}">
        ${a.em} ${a.nm} ${owned?eq?'âœ“':'â—‹':`${a.cost}ğŸª™`}${locked?` ğŸ”’${a.ul}`:''}</div>`}h+='</div>';break;
  case'achieve':h+=`<h2>ğŸ† Achievements</h2><button class="pc" onclick="cp()">âœ•</button><div style="font-size:11px;color:var(--tl);margin-bottom:8px">${G.achievements.size}/${ACHS.length}</div>`;
    for(const a of ACHS){const done=G.achievements.has(a.id);
      h+=`<div class="ach ${done?'done':'todo'}"><span style="font-size:20px">${a.em}</span><div style="flex:1"><div style="font-weight:600;font-size:12px">${a.nm}${done?' âœ…':''}</div>
        <div style="font-size:10px;color:var(--tl)">${a.desc}</div></div><div style="font-size:10px;color:#b8860b;font-weight:600">${a.rw}ğŸª™</div></div>`}break;
  case'inv':h+=`<h2>ğŸ’ Inventory</h2><button class="pc" onclick="cp()">âœ•</button><div class="ig">`;let hasAny=false;
    for(let i=0;i<10;i++){if(G.inv[i]>0){hasAny=true;h+=`<div class="ii" onclick="sellFlower(${i});op('inv')">${FL[i].em} <span class="ct">${G.inv[i]}</span> <span style="font-size:9px;color:var(--tl)">(tap=sell ${FL[i].sv}ğŸª™)</span></div>`}}
    if(!hasAny)h+='<div class="et">No flowers yet!</div>';h+='</div>';
    h+=`<div class="sl">ğŸ“Š Stats</div><div style="font-size:11px;color:var(--tl);line-height:2">ğŸŒ¸ ${G.stats.harvested} | ğŸª™ ${G.stats.coinsEarned} | ğŸ“‹ ${G.stats.ordersCompleted} | ğŸ’ ${G.stats.bouquetsMade}<br>â›ˆï¸ ${G.stats.stormsWeathered} | ğŸ€ ${G.stats.luckyHarvests} | ğŸ± ${G.stats.catFed} | ğŸ ${G.stats.giftsRcvd}</div>`;break;
  case'guide':h+=renderGuide();break}
  c.innerHTML=h;document.getElementById('panelO').classList.add('on')}
function cp(){document.getElementById('panelO').classList.remove('on');G.activePanel=null;SFX.panelClose()}
function sellFL_shop(fi){if(FL[fi].ul>G.level||G.coins<FL[fi].sc)return;
  if(G.view==='farm'&&G.sPlot>=0){plantSeed(fi);cp();return}toast(`Go to a farm and tap an empty plot to plant ${FL[fi].em}!`);cp()}
const GUIDE_PAGES=[
  {title:'ğŸŒ¸ Welcome!',body:`<b>Bloom & Drizzle</b> is a cozy flower farming game!<br><br>ğŸŒ± <b>Plant seeds</b> â†’ Watch them grow â†’ ğŸŒ¸ <b>Harvest</b><br>ğŸ’ <b>Craft bouquets</b> â†’ ğŸ“‹ <b>Fill orders</b> â†’ ğŸª™ <b>Earn coins</b><br><br>Tap <b>farms</b> to enter. Tap empty plots to plant! <b>Drag to pan, pinch to zoom!</b>`},
  {title:'ğŸŒ§ï¸ Weather',body:`Weather affects crops!<br><br>â˜€ï¸ <b>Sunny</b> â€” Normal<br>ğŸŒ¦ï¸ <b>Drizzle</b> â€” +25% growth<br>ğŸŒ§ï¸ <b>Rain</b> â€” +50% growth<br>â›ˆï¸ <b>Storm</b> â€” 2x growth but damage risk!<br>ğŸŒ«ï¸ <b>Fog</b> â€” Normal, cozy vibes`},
  {title:'â­ Leveling Up',body:`Earn XP to unlock flowers, recipes, tools & accessories!<br><br>ğŸŒ¸ Harvesting = XP<br>ğŸ’ Bouquets = XP<br>ğŸ“‹ Orders = XP<br>ğŸ± Petting = +1 XP<br>ğŸ”§ Upgrading = +20 XP`},
  {title:'ğŸ± Mochi',body:`Keep Mochi happy for bonuses!<br><br>ğŸŸ <b>Feed</b> in Mochi panel<br>ğŸ’• <b>Pet</b> â€” tap Mochi<br><br>Happy Mochi (>70) = <b>15% lucky harvest!</b><br>High trust = Mochi finds <b>gifts</b>! ğŸ`},
  {title:'ğŸ’¡ Tips',body:`â€¢ Upgrade <b>Watering Can</b> for auto-water<br>â€¢ <b>Bouquets</b> > individual flowers<br>â€¢ <b>Orders</b> pay premium â€” fill before timeout!<br>â€¢ Buy more <b>farms</b> for more flowers<br>â€¢ <b>â© 3x</b> speed in farm view<br>â€¢ Tap ğŸ’€ to clear damaged plots<br>â€¢ <b>Drag to pan</b>, <b>pinch/scroll to zoom</b><br>â€¢ <b>Double-tap to recenter</b> the view`},
];
function renderGuide(){let h=`<h2>ğŸ“– How to Play</h2><button class="pc" onclick="cp()">âœ•</button>`;
  const pg=GUIDE_PAGES[G.guidePage];h+=`<div class="guide-page"><h3>${pg.title}</h3><p>${pg.body}</p></div><div class="guide-nav">`;
  for(let i=0;i<GUIDE_PAGES.length;i++)h+=`<div class="guide-dot${i===G.guidePage?' active':''}" onclick="G.guidePage=${i};op('guide')"></div>`;
  h+=`</div>`;
  if(G.guidePage<GUIDE_PAGES.length-1)h+=`<div style="text-align:center;margin-top:8px"><button class="fb" onclick="G.guidePage++;op('guide')">Next â†’</button></div>`;
  else h+=`<div style="text-align:center;margin-top:8px"><button class="fb" onclick="cp()">Let's Play! ğŸŒ¸</button></div>`;return h}
function openSeedSel(pi){G.sPlot=pi;G.ssOpen=true;SFX.panelOpen();
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:14px">ğŸŒ± Choose Seed</span><button class="pc" onclick="closeSeedSel()" style="position:static">âœ•</button></div>`;
  for(const fl of FL){if(fl.ul>G.level)continue;const can=G.coins>=fl.sc;
    h+=`<div class="so" onclick="plantSeed(${fl.id})" style="opacity:${can?1:.4}"><span style="font-size:22px">${fl.em}</span>
      <div style="flex:1"><div style="font-weight:600;font-size:12px">${fl.nm}</div>
      <div style="font-size:9px;color:var(--tl)">${fl.gt}s grow â€¢ ${fl.sv}ğŸª™</div></div>
      <div style="font-weight:600;color:#b8860b">${fl.sc}ğŸª™</div></div>`}
  document.getElementById('seedSel').innerHTML=h;document.getElementById('seedSel').classList.add('on')}
function closeSeedSel(){G.ssOpen=false;G.sPlot=-1;document.getElementById('seedSel').classList.remove('on')}
function showPurchase(fi){const cost=FCOST[fi];
  document.getElementById('purchP').innerHTML=`<h3>ğŸ¡ Buy Farm ${fi+1}?</h3><div class="pr">${cost}ğŸª™</div>
    <p style="font-size:11px;color:var(--tl);margin:8px 0">12 plots for growing flowers!</p>
    <div class="pb"><button class="pbtn cf" onclick="buyFarm(${fi});closePurch()" ${G.coins>=cost?'':'disabled'}>Buy</button>
    <button class="pbtn cn" onclick="closePurch()">Cancel</button></div>`;
  document.getElementById('purchO').classList.add('on')}
function closePurch(){document.getElementById('purchO').classList.remove('on')}
function toast(msg){const c=document.getElementById('toastC'),t=document.createElement('div');t.className='toast';t.textContent=msg;c.appendChild(t);setTimeout(()=>t.remove(),2500)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ–±ï¸ INPUT â€” TAP vs DRAG + PINCH ZOOM (NEW!)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let touchState={dragging:false,startX:0,startY:0,startTime:0,lastX:0,lastY:0,pinchDist:0,pinching:false,lastTapTime:0};
const TAP_THRESHOLD=12,TAP_TIME=300,DOUBLE_TAP_TIME=350;

function handleClick(sx,sy){
  if(G.ssOpen)return;
  const w=s2w(sx,sy);// convert screen to world
  if(G.view==='village'){
    const g=uniso(w.x,w.y);const gxi=Math.floor(g.gx),gyi=Math.floor(g.gy);
    if(gxi>=0&&gxi<10&&gyi>=0&&gyi<10){
      if(VMAP[gyi]&&VMAP[gyi][gxi]!==undefined){
        G.player.gx=gxi;G.player.gy=gyi;
        const ps=iso(gxi,gyi);G.cat.tx=ps.x+20+Math.random()*20;G.cat.ty=ps.y+Math.random()*10;
        // Smooth camera follow player
        cam.tx=ps.x;cam.ty=ps.y}
      const fi=FARM_POS.findIndex(f=>f.gx===gxi&&f.gy===gyi);
      if(fi>=0){if(G.farms[fi].unlocked)enterFarm(fi);else showPurchase(fi)}
      if(VMAP[gyi][gxi]===4){SFX.click();op('shop')}}
    // Cat click
    const cd=Math.sqrt((w.x-G.cat.x)**2+(w.y-G.cat.y)**2);
    if(cd<40)petCat();
  }else if(G.view==='farm'){
    const farm=G.farms[G.cFarm];
    for(let i=0;i<12;i++){const p=farm.plots[i];if(p._sx===undefined)continue;
      const dx=Math.abs(w.x-p._sx),dy=Math.abs(w.y-p._sy);
      if(dx<=p._tw/2&&dy<=p._th/2){
        if(p.dmg){harvestPlot(i);return}
        if(p.fi>=0&&p.pr>=1){harvestPlot(i);return}
        if(p.fi<0){openSeedSel(i);return}
        if(p.fi>=0&&!p.wet){p.wet=true;SFX.water();addP('sparkle',p._sx,p._sy,2);return}}}
    const cd=Math.sqrt((w.x-G.cat.x)**2+(w.y-G.cat.y)**2);
    if(cd<40)petCat()}}

function getPinchDist(ts){const dx=ts[0].clientX-ts[1].clientX,dy=ts[0].clientY-ts[1].clientY;return Math.sqrt(dx*dx+dy*dy)}

gc.addEventListener('mousedown',e=>{touchState.startX=e.clientX;touchState.startY=e.clientY;touchState.lastX=e.clientX;touchState.lastY=e.clientY;touchState.startTime=Date.now();touchState.dragging=true});
gc.addEventListener('mousemove',e=>{
  G.mx=e.clientX;G.my=e.clientY;
  if(!touchState.dragging)return;
  const dx=e.clientX-touchState.lastX,dy=e.clientY-touchState.lastY;
  cam.tx-=dx/cam.zoom;cam.ty-=dy/cam.zoom;
  touchState.lastX=e.clientX;touchState.lastY=e.clientY});
gc.addEventListener('mouseup',e=>{
  if(!touchState.dragging)return;touchState.dragging=false;
  const dx=e.clientX-touchState.startX,dy=e.clientY-touchState.startY,dist=Math.sqrt(dx*dx+dy*dy);
  if(dist<TAP_THRESHOLD&&Date.now()-touchState.startTime<TAP_TIME){
    const now=Date.now();if(now-touchState.lastTapTime<DOUBLE_TAP_TIME){autoZoom()}
    else{ensA();handleClick(e.clientX,e.clientY)}
    touchState.lastTapTime=now}});
gc.addEventListener('wheel',e=>{e.preventDefault();
  const zf=e.deltaY>0?.9:1.1;cam.tz=Math.max(.4,Math.min(3,cam.tz*zf))},{passive:false});

gc.addEventListener('touchstart',e=>{
  e.preventDefault();ensA();
  if(e.touches.length===2){touchState.pinching=true;touchState.pinchDist=getPinchDist(e.touches);return}
  const t=e.touches[0];touchState.startX=t.clientX;touchState.startY=t.clientY;touchState.lastX=t.clientX;touchState.lastY=t.clientY;touchState.startTime=Date.now();touchState.dragging=true},{passive:false});
gc.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(touchState.pinching&&e.touches.length>=2){const d=getPinchDist(e.touches);const ratio=d/touchState.pinchDist;
    cam.tz=Math.max(.4,Math.min(3,cam.zoom*ratio));touchState.pinchDist=d;return}
  if(!touchState.dragging||e.touches.length!==1)return;
  const t=e.touches[0];G.mx=t.clientX;G.my=t.clientY;
  const dx=t.clientX-touchState.lastX,dy=t.clientY-touchState.lastY;
  cam.tx-=dx/cam.zoom;cam.ty-=dy/cam.zoom;
  touchState.lastX=t.clientX;touchState.lastY=t.clientY},{passive:false});
gc.addEventListener('touchend',e=>{
  if(touchState.pinching){if(e.touches.length<2)touchState.pinching=false;return}
  if(!touchState.dragging)return;touchState.dragging=false;
  const dx=(e.changedTouches[0]?.clientX||0)-touchState.startX,dy=(e.changedTouches[0]?.clientY||0)-touchState.startY;
  const dist=Math.sqrt(dx*dx+dy*dy);
  if(dist<TAP_THRESHOLD&&Date.now()-touchState.startTime<TAP_TIME){
    const now=Date.now();if(now-touchState.lastTapTime<DOUBLE_TAP_TIME){autoZoom()}
    else{handleClick(e.changedTouches[0].clientX,e.changedTouches[0].clientY)}
    touchState.lastTapTime=now}});
document.addEventListener('mousemove',e=>{G.mx=e.clientX;G.my=e.clientY});
document.addEventListener('keydown',e=>{if(e.key==='Escape'){if(G.ssOpen)closeSeedSel();else if(G.activePanel)cp();else if(G.view==='farm')exitFarm()}});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”„ GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastT=0;
function gameLoop(ts){
  const dt=Math.min((ts-lastT)/1000,.05);lastT=ts;G.time=ts/1000;
  updWeather(dt);updGrowth(dt);updStorm(dt);updDay(dt);updOrders(dt);updCat(dt);updRain(dt);updParts(dt);
  camLerp(dt);
  gx.clearRect(0,0,W,H);
  if(G.view==='village')drawVillage();else drawFarmView();
  drawRain();
  // Fog overlay (screen space)
  if(G.weather.id==='fog'){
    const fg=gx.createRadialGradient(W/2,H/2,W*.15,W/2,H/2,W*.6);
    fg.addColorStop(0,'rgba(200,195,210,0)');fg.addColorStop(1,'rgba(200,195,210,.35)');
    gx.fillStyle=fg;gx.fillRect(0,0,W,H)}
  if(G.weather.id==='sunny'){gx.fillStyle='rgba(255,240,200,.06)';gx.fillRect(0,0,W,H)}
  requestAnimationFrame(gameLoop)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸš€ INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init(){resize();updUI();setTimeout(()=>op('guide'),800);requestAnimationFrame(gameLoop)}
init();
</script></body></html>
